<!DOCTYPE html>
<!-- 
    THE CLOSING LANE™ — 2026 Edition v2.1
    5-Tab Consolidated Build
    Consistency beats intensity. The week is the atomic unit.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE CLOSING LANE™ — 2026 Edition</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>≡</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #0d1117;
            --accent: #00d4aa;
            --accent-dim: rgba(0, 212, 170, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --card-bg: rgba(255, 255, 255, 0.03);
            --card-border: rgba(255, 255, 255, 0.05);
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --secondary: #8b5cf6;
        }
        
        .light-mode {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --card-bg: rgba(0, 0, 0, 0.02);
            --card-border: rgba(0, 0, 0, 0.08);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        h1 { font-size: 2.5rem; font-weight: 800; line-height: 1.2; }
        h2 { font-size: 1.875rem; font-weight: 700; line-height: 1.3; }
        h3 { font-size: 1.25rem; font-weight: 600; }
        h4 { font-size: 1rem; font-weight: 600; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }
        .hidden { display: none !important; }
        
        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            padding: 1.5rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .btn-primary {
            background: var(--accent);
            color: #000;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 212, 170, 0.4);
        }
        
        .btn-secondary {
            background: transparent;
            border: 1px solid var(--card-border);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--card-bg);
            border-color: var(--accent);
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }
        
        .btn-ghost:hover {
            color: var(--accent);
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }
        
        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        input, textarea, select {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        textarea { resize: vertical; min-height: 100px; }
        
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        
        .ceo-line {
            border-left: 3px solid var(--accent);
            padding: 1rem 1.25rem;
            background: var(--accent-dim);
            border-radius: 0 0.5rem 0.5rem 0;
            font-style: italic;
            color: var(--text-secondary);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--card-border);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .progress-fill.complete {
            background: linear-gradient(90deg, var(--accent), var(--success));
        }
        
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .pill-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .pill-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .pill-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .pill-neutral { background: var(--card-bg); color: var(--text-secondary); }
        
        /* ==================== HEADER & NAV ==================== */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--card-border);
        }
        
        .light-mode .header {
            background: rgba(255, 255, 255, 0.9);
        }
        
        .header-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 800;
            font-size: 1.25rem;
        }
        
        .logo-icon {
            width: 2rem;
            height: 2rem;
            background: var(--accent);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .theme-toggle, .export-btn {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }
        
        .export-btn:hover, .theme-toggle:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        /* 5-TAB NAVIGATION */
        .tab-nav {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 1.5rem 0;
            max-width: 1200px;
            margin: 0 auto;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 0.875rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-btn:hover {
            color: var(--text-secondary);
        }
        
        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        
        .tab-content {
            padding: 2rem 0 4rem;
        }
        
        /* ==================== STREAK BADGE ==================== */
        .streak-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 700;
            font-size: 0.875rem;
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(247, 147, 30, 0.4); }
            50% { box-shadow: 0 0 20px rgba(247, 147, 30, 0.7); }
        }
        
        /* ==================== CONFETTI ==================== */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }
        
        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translateY(-100px) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(100vh) rotate(720deg);
            }
        }
        
        /* ==================== CELEBRATION BANNER ==================== */
        .celebration-banner {
            background: linear-gradient(135deg, var(--accent), var(--success));
            color: #000;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            text-align: center;
            font-weight: 600;
            margin-bottom: 1.5rem;
            animation: celebrate-pop 0.5s ease;
        }
        
        @keyframes celebrate-pop {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* ==================== COMMAND CENTER ==================== */
        .command-hero {
            text-align: center;
            padding: 2rem 0 1rem;
        }
        
        .command-hero h1 {
            margin-bottom: 0.5rem;
        }
        
        .week-position {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .lane-display {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--accent-dim);
            border: 1px solid var(--accent);
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1.5rem;
        }
        
        .lane-display:hover {
            background: rgba(0, 212, 170, 0.3);
        }
        
        .lane-display .lane-icon {
            font-size: 1.5rem;
        }
        
        .lane-display .lane-name {
            font-weight: 700;
            color: var(--accent);
        }
        
        .lane-display .lane-change {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Weekly Target Display */
        .weekly-target-display {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 500px;
            margin: 0 auto 2rem;
        }
        
        .weekly-target-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .weekly-target-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
        }
        
        .weekly-target-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent);
        }
        
        .weekly-progress-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            font-size: 0.875rem;
        }
        
        .weekly-pace {
            color: var(--text-secondary);
        }
        
        .weekly-flexibility {
            text-align: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--card-border);
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        /* Status Cards */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .status-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            padding: 1.25rem;
            text-align: center;
        }
        
        .status-card-value {
            font-size: 2rem;
            font-weight: 800;
        }
        
        .status-card-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 0.25rem;
        }
        
        .status-card.accent .status-card-value {
            color: var(--accent);
        }
        
        .status-card.success .status-card-value {
            color: var(--success);
        }
        
        /* Quick Reference */
        .quick-reference {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .quick-reference h3 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quick-ref-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .quick-ref-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .quick-ref-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .quick-ref-value {
            font-weight: 600;
        }
        
        /* Next Action */
        .next-action {
            background: var(--accent-dim);
            border: 1px solid var(--accent);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .next-action-icon {
            font-size: 2rem;
        }
        
        .next-action-text h4 {
            color: var(--accent);
            margin-bottom: 0.25rem;
        }
        
        /* Doctrine Link */
        .doctrine-link {
            text-align: center;
            margin-top: 2rem;
        }
        
        .doctrine-link a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s;
        }
        
        .doctrine-link a:hover {
            color: var(--accent);
        }
        
        /* ==================== DEALS TAB ==================== */
        .gci-hero {
            background: linear-gradient(135deg, var(--card-bg), var(--accent-dim));
            border: 1px solid var(--accent);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .gci-hero-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            text-align: center;
        }
        
        .gci-hero-item h4 {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .gci-hero-value {
            font-size: 1.75rem;
            font-weight: 800;
        }
        
        .gci-hero-value.goal { color: var(--text-secondary); }
        .gci-hero-value.actual { color: var(--success); }
        .gci-hero-value.remaining { color: var(--warning); }
        .gci-hero-value.pace { color: var(--accent); }
        
        .gci-progress-container {
            margin-top: 1.5rem;
        }
        
        .gci-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        /* Pipeline */
        .pipeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .pipeline-stages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }
        
        .pipeline-stage {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            padding: 1rem;
            min-height: 250px;
        }
        
        .stage-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--card-border);
        }
        
        .stage-title {
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .stage-count {
            background: var(--accent-dim);
            color: var(--accent);
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .stage-gci {
            font-size: 0.75rem;
            color: var(--success);
            margin-top: 0.25rem;
        }
        
        .deal-card {
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .deal-card:hover {
            border-color: var(--accent);
        }
        
        .deal-name {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .deal-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }
        
        .deal-gci {
            color: var(--success);
            font-weight: 600;
        }
        
        .stage-add {
            background: transparent;
            border: 1px dashed var(--card-border);
            border-radius: 0.5rem;
            padding: 0.5rem;
            color: var(--text-muted);
            cursor: pointer;
            width: 100%;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .stage-add:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        /* Closed Deals Log */
        .closed-deals-section {
            margin-top: 2rem;
        }
        
        .closed-deals-section h3 {
            margin-bottom: 1rem;
        }
        
        .closed-deals-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .closed-deals-table th,
        .closed-deals-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--card-border);
        }
        
        .closed-deals-table th {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .closed-deals-table .gci-cell {
            color: var(--success);
            font-weight: 600;
        }
        
        /* ==================== ACTIVITY TAB ==================== */
        .quick-log-bar {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        
        .quick-log-bar h4 {
            margin-bottom: 0.75rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        
        .quick-log-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .quick-log-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-log-btn:hover {
            border-color: var(--accent);
            background: var(--accent-dim);
        }
        
        .quick-log-btn.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }
        
        /* Calendar */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .calendar-nav button {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        
        .calendar-nav button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .calendar-month-label {
            font-size: 1.25rem;
            font-weight: 600;
            min-width: 180px;
            text-align: center;
        }
        
        .calendar-stats {
            display: flex;
            gap: 1.5rem;
        }
        
        .calendar-stat {
            text-align: center;
        }
        
        .calendar-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .calendar-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }
        
        .calendar-day-header {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 0.5rem;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .calendar-day:hover {
            border-color: var(--accent);
        }
        
        .calendar-day.other-month {
            opacity: 0.3;
        }
        
        .calendar-day.today {
            border-color: var(--accent);
            border-width: 2px;
        }
        
        .calendar-day.has-activity {
            background: var(--accent-dim);
        }
        
        .calendar-day.target-hit {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--success);
        }
        
        .calendar-day-number {
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .calendar-day-indicator {
            position: absolute;
            bottom: 4px;
            display: flex;
            gap: 2px;
        }
        
        .calendar-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
        }
        
        /* Post-Log Prompt */
        .post-log-prompt {
            background: var(--accent-dim);
            border: 1px solid var(--accent);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            animation: slide-up 0.3s ease;
        }
        
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .post-log-prompt h4 {
            margin-bottom: 1rem;
            color: var(--accent);
        }
        
        .prompt-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .prompt-category-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .prompt-category-btn:hover {
            border-color: var(--accent);
        }
        
        /* Prompts Library Dropdown */
        .prompts-dropdown {
            margin-top: 2rem;
        }
        
        .prompts-dropdown-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            cursor: pointer;
        }
        
        .prompts-dropdown-header:hover {
            border-color: var(--accent);
        }
        
        .prompts-dropdown-content {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 0;
            overflow: hidden;
            padding: 0 1rem;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .prompts-dropdown-content.open {
            max-height: 2000px;
            padding: 1rem;
        }
        
        .prompt-card {
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .prompt-header {
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .prompt-header:hover {
            background: var(--card-bg);
        }
        
        .prompt-title {
            font-weight: 600;
        }
        
        .prompt-toggle {
            transition: transform 0.2s;
        }
        
        .prompt-card.open .prompt-toggle {
            transform: rotate(180deg);
        }
        
        .prompt-content {
            padding: 0 1rem 1rem;
            display: none;
        }
        
        .prompt-card.open .prompt-content {
            display: block;
        }
        
        .prompt-text {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            margin-bottom: 1rem;
        }
        
        /* ==================== REVIEW TAB ==================== */
        .review-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .review-tab {
            padding: 0.75rem 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            color: var(--text-muted);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .review-tab:hover {
            border-color: var(--text-muted);
        }
        
        .review-tab.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .review-tab.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .review-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .review-section-title {
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .metric-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--card-border);
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .metric-input {
            width: 80px;
            text-align: center;
            padding: 0.5rem;
        }
        
        .check-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .check-row:hover {
            background: var(--card-bg);
        }
        
        .check-row.completed {
            background: var(--accent-dim);
        }
        
        .check-row input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
            pointer-events: none;
        }
        
        .check-row label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }
        
        /* Database Health */
        .health-meter {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .health-meter-bar {
            flex: 1;
            height: 12px;
            background: var(--card-border);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .health-meter-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s;
        }
        
        .health-meter-fill.danger { background: var(--danger); }
        .health-meter-fill.warning { background: var(--warning); }
        .health-meter-fill.success { background: var(--success); }
        
        .health-meter-value {
            font-weight: 700;
            min-width: 50px;
            text-align: right;
        }
        
        /* Week Counter */
        .week-counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: var(--accent-dim);
            border-radius: 1rem;
        }
        
        .week-counter-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--accent);
        }
        
        .week-counter-label {
            color: var(--text-secondary);
        }
        
        /* 14 Standards */
        .standard-card {
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }
        
        .standard-header {
            padding: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .standard-header:hover {
            background: var(--card-bg);
        }
        
        .standard-number {
            width: 28px;
            height: 28px;
            background: var(--accent-dim);
            color: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
        }
        
        .standard-title {
            flex: 1;
            font-weight: 600;
        }
        
        .standard-check {
            color: var(--success);
            font-size: 1.25rem;
        }
        
        .standard-content {
            padding: 0 1rem 1rem 3rem;
            display: none;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .standard-card.open .standard-content {
            display: block;
        }
        
        /* ==================== YOUR LANE TAB ==================== */
        .build-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 1rem;
        }
        
        .build-progress-bar {
            flex: 1;
            height: 8px;
            background: var(--card-border);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .build-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .build-progress-text {
            font-weight: 600;
            color: var(--accent);
        }
        
        .build-step {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .build-step.completed {
            border-color: var(--success);
        }
        
        .build-step-header {
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .build-step-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        .build-step-number {
            width: 32px;
            height: 32px;
            background: var(--accent-dim);
            color: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        .build-step.completed .build-step-number {
            background: var(--success);
            color: #fff;
        }
        
        .build-step-title {
            flex: 1;
            font-weight: 600;
        }
        
        .build-step-toggle {
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        
        .build-step.open .build-step-toggle {
            transform: rotate(180deg);
        }
        
        .build-step-content {
            padding: 0 1.5rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .build-step.open .build-step-content {
            max-height: 800px;
            padding: 0 1.5rem 1.5rem;
        }
        
        /* Help Section */
        .help-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--card-border);
        }
        
        .help-section h3 {
            margin-bottom: 1rem;
        }
        
        .help-item {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .help-question {
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }
        
        .help-question:hover {
            color: var(--accent);
        }
        
        .help-answer {
            padding: 0 1rem 1rem;
            display: none;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .help-item.open .help-answer {
            display: block;
        }
        
        /* Reset Button */
        .reset-section {
            margin-top: 3rem;
            padding: 2rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 1rem;
            text-align: center;
        }
        
        .reset-section h4 {
            color: var(--danger);
            margin-bottom: 0.5rem;
        }
        
        .reset-section p {
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        /* ==================== MODALS ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            opacity: 1;
            transition: opacity 0.2s ease;
        }
        
        .modal-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(1) translateY(0);
            transition: transform 0.2s ease;
        }
        
        .modal-overlay.hidden .modal {
            transform: scale(0.95) translateY(-10px);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid var(--card-border);
        }
        
        .modal-header h3 {
            font-size: 1.25rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1.5rem;
            border-top: 1px solid var(--card-border);
        }
        
        /* Lane Selector Modal */
        .lane-option {
            padding: 1rem;
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s;
        }
        
        .lane-option:hover {
            border-color: var(--accent);
            background: var(--accent-dim);
        }
        
        .lane-option.selected {
            border-color: var(--accent);
            background: var(--accent-dim);
        }
        
        .setup-lane-option:hover {
            border-color: var(--accent) !important;
            background: var(--accent-dim) !important;
        }
        
        .lane-option-icon {
            font-size: 2rem;
        }
        
        .lane-option-info h4 {
            margin-bottom: 0.25rem;
        }
        
        .lane-option-info p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* ==================== NOTIFICATIONS ==================== */
        .notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--accent);
            color: #000;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            z-index: 1001;
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(-50%) translateY(0);
        }
        
        /* ==================== MOBILE BOTTOM NAV ==================== */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--card-border);
            z-index: 1000;
            padding: 0.5rem 0;
            padding-bottom: env(safe-area-inset-bottom, 0.5rem);
        }
        
        .light-mode .mobile-nav {
            background: rgba(255, 255, 255, 0.95);
        }
        
        .mobile-nav-inner {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .mobile-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .mobile-nav-btn.active {
            color: var(--accent);
        }
        
        .mobile-nav-btn .nav-icon {
            font-size: 1.25rem;
        }
        
        .mobile-nav-btn .nav-label {
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        /* ==================== BACKUP REMINDER ==================== */
        .backup-reminder {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid var(--warning);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .backup-reminder-text {
            font-size: 0.875rem;
            color: var(--warning);
        }
        
        .backup-reminder-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .backup-reminder-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        
        .backup-reminder-btn.primary {
            background: var(--warning);
            color: #000;
        }
        
        .backup-reminder-btn.dismiss {
            background: transparent;
            color: var(--text-muted);
        }
        
        /* ==================== DRAG AND DROP ==================== */
        .deal-card {
            cursor: grab;
        }
        
        .deal-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .pipeline-stage.drag-over {
            border-color: var(--accent);
            background: var(--accent-dim);
        }
        
        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .mobile-nav { display: block; }
            body { padding-bottom: 100px; }
            .tab-nav { display: none; }
            h1 { font-size: 1.75rem; }
            h2 { font-size: 1.5rem; }
            
            .tab-nav {
                padding: 0 0.5rem;
            }
            
            .tab-btn {
                padding: 0.75rem 1rem;
                font-size: 0.8rem;
            }
            
            .container {
                padding: 0 1rem;
            }
            
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .pipeline-stages {
                grid-template-columns: 1fr;
            }
            
            .calendar-stats {
                display: none;
            }
            
            .gci-hero-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Print Stylesheet */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                background: white !important;
                color: #1a1a1a !important;
                font-size: 11pt;
            }
            
            .nav, .confetti-container, .modal-overlay, 
            .quick-log-section, .prompts-dropdown,
            .post-log-prompt, .help-section,
            button, .btn, .notification {
                display: none !important;
            }
            
            .main-content {
                max-width: 100% !important;
                padding: 0 !important;
            }
            
            .section {
                display: block !important;
                page-break-inside: avoid;
            }
            
            .section.hidden {
                display: none !important;
            }
            
            .card, .status-card, .pipeline-column, .deal-card {
                background: white !important;
                border: 1px solid #ccc !important;
                box-shadow: none !important;
            }
            
            .command-header, .section-header {
                background: #f5f5f5 !important;
            }
            
            h1, h2, h3, h4 {
                color: #1a1a1a !important;
            }
            
            .text-muted, .text-secondary {
                color: #666 !important;
            }
            
            .calendar-grid {
                gap: 2px !important;
            }
            
            .calendar-day {
                border: 1px solid #ddd !important;
                padding: 4px !important;
            }
            
            .calendar-day.has-activity {
                background: #e8f4e8 !important;
            }
            
            .calendar-day.target-hit {
                background: #d4edda !important;
            }
            
            @page {
                margin: 0.75in;
                size: letter portrait;
            }
        }
    </style>
</head>
<body>
    <!-- Confetti Container -->
    <div id="confettiContainer" class="confetti-container"></div>
    
    <!-- Notification -->
    <div id="notification" class="notification">Saved!</div>
    
    <!-- Header -->
    <header class="header" role="banner">
        <div class="header-inner">
            <div class="logo">
                <div class="logo-icon" aria-hidden="true">≡</div>
                <span>THE CLOSING LANE™</span>
            </div>
            <div class="header-actions">
                <button class="export-btn" onclick="triggerImport()" title="Import Data" aria-label="Import data from backup file">↓</button>
                <button class="export-btn" onclick="exportData()" title="Export Data" aria-label="Export data to backup file">↑</button>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme" aria-label="Toggle light/dark theme">◐</button>
            </div>
        </div>
        
        <!-- 5-Tab Navigation -->
        <nav class="tab-nav" role="tablist" aria-label="Main navigation">
            <button class="tab-btn active" onclick="switchTab('command')" role="tab" aria-selected="true">Command</button>
            <button class="tab-btn" onclick="switchTab('deals')" role="tab" aria-selected="false">Deals</button>
            <button class="tab-btn" onclick="switchTab('activity')" role="tab" aria-selected="false">Activity</button>
            <button class="tab-btn" onclick="switchTab('review')" role="tab" aria-selected="false">Review</button>
            <button class="tab-btn" onclick="switchTab('lane')" role="tab" aria-selected="false">Your Lane</button>
        </nav>
    </header>
    
    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-inner">
            <button class="mobile-nav-btn active" onclick="switchTab('command')">
                <span class="nav-icon">◉</span>
                <span class="nav-label">Command</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('deals')">
                <span class="nav-icon">◆</span>
                <span class="nav-label">Deals</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('activity')">
                <span class="nav-icon">▣</span>
                <span class="nav-label">Activity</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('review')">
                <span class="nav-icon">▤</span>
                <span class="nav-label">Review</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchTab('lane')">
                <span class="nav-icon">≡</span>
                <span class="nav-label">Setup</span>
            </button>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main>
        <!-- ==================== TAB 1: COMMAND ==================== -->
        <div id="tab-command" class="tab-content">
            <div class="container">
                <!-- Backup Reminder -->
                <div id="backupReminder" class="backup-reminder hidden">
                    <span class="backup-reminder-text">It's been 7+ days since your last backup. Protect your data.</span>
                    <div class="backup-reminder-actions">
                        <button class="backup-reminder-btn primary" onclick="exportData()">Backup Now</button>
                        <button class="backup-reminder-btn dismiss" onclick="dismissBackupReminder()">Dismiss</button>
                    </div>
                </div>
                
                <!-- Confirmation Banner (shown when weekly standard met) -->
                <div id="celebrationBanner" class="celebration-banner hidden">
                    Weekly standard met. Consistency confirmed.
                </div>
                
                <!-- Welcome Back Banner (shown after 14+ days) -->
                <div id="welcomeBackBanner" class="ceo-line hidden" style="margin-bottom: 1.5rem;">
                    The system doesn't judge gaps. Start with this week.
                </div>
                
                <div class="command-hero">
                    <h1>Welcome back<span id="userName"></span></h1>
                    <p class="week-position" id="weekPosition">Week 1 of 52 • 2026</p>
                    
                    <!-- Streak Badge -->
                    <div id="streakBadge" class="streak-badge hidden">
                        <span id="streakCount">0</span> weeks of continuity
                    </div>
                    
                    <!-- Lane Display (Clickable) -->
                    <div class="lane-display" onclick="openLaneSelector()">
                        <span class="lane-icon" id="currentLaneIcon">●</span>
                        <div>
                            <div class="lane-name" id="currentLaneName">Select Your Lane</div>
                            <div class="lane-change" id="laneStatus">Click to select →</div>
                        </div>
                    </div>
                </div>
                
                <!-- Weekly Target Display -->
                <div class="weekly-target-display">
                    <div class="weekly-target-header">
                        <span class="weekly-target-label">Weekly Target</span>
                        <span class="weekly-target-number"><span id="weeklyTargetNumber">15</span> conversations</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="weeklyProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="weekly-progress-text">
                        <span>This week: <strong id="weeklyLogged">0</strong> of <span id="weeklyTarget">15</span></span>
                        <span class="weekly-pace" id="weeklyPace">To stay on pace: ~3/day</span>
                    </div>
                    <div class="weekly-flexibility">
                        You don't have to hit it daily. Just close the week complete.
                    </div>
                </div>
                
                <!-- Status Cards -->
                <div class="status-grid">
                    <div class="status-card accent">
                        <div class="status-card-value" id="calmNumber">2</div>
                        <div class="status-card-label">Calm Number</div>
                    </div>
                    <div class="status-card">
                        <div class="status-card-value" id="thisWeekConvos">0</div>
                        <div class="status-card-label">This Week</div>
                    </div>
                    <div class="status-card">
                        <div class="status-card-value" id="weeksCompleted">0</div>
                        <div class="status-card-label">Weeks Complete</div>
                    </div>
                    <div class="status-card">
                        <div class="status-card-value" id="pipelineCount">0</div>
                        <div class="status-card-label">Pipeline</div>
                    </div>
                    <div class="status-card success">
                        <div class="status-card-value" id="ytdGci">$0</div>
                        <div class="status-card-label">YTD GCI</div>
                    </div>
                </div>
                
                <!-- Next Action -->
                <div class="next-action" id="nextAction">
                    <span class="next-action-icon">→</span>
                    <div class="next-action-text">
                        <h4>Next Action</h4>
                        <p id="nextActionText">Log today's conversations to stay on track.</p>
                    </div>
                </div>
                
                <!-- Quick Reference -->
                <div class="quick-reference">
                    <h3>Quick Reference</h3>
                    <div class="quick-ref-grid">
                        <div class="quick-ref-item">
                            <span class="quick-ref-label">Lane Focus</span>
                            <span class="quick-ref-value" id="qrLane">-</span>
                        </div>
                        <div class="quick-ref-item">
                            <span class="quick-ref-label">Calm Number</span>
                            <span class="quick-ref-value" id="qrCalm">-</span>
                        </div>
                        <div class="quick-ref-item">
                            <span class="quick-ref-label">CEO Hour</span>
                            <span class="quick-ref-value" id="qrCeo">-</span>
                        </div>
                        <div class="quick-ref-item">
                            <span class="quick-ref-label">30-Day Focus</span>
                            <span class="quick-ref-value" id="qrFocus">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Doctrine Link -->
                <div class="doctrine-link">
                    <a href="#" onclick="showDoctrine(); return false;">Why this works →</a>
                </div>
            </div>
        </div>
        
        <!-- ==================== TAB 2: DEALS ==================== -->
        <div id="tab-deals" class="tab-content hidden">
            <div class="container">
                <h2>Deals & GCI</h2>
                
                <!-- GCI Hero (Top of Page) -->
                <div class="gci-hero">
                    <div class="gci-hero-grid">
                        <div class="gci-hero-item">
                            <h4>2026 Goal</h4>
                            <div class="gci-hero-value goal" id="gciGoal">$0</div>
                        </div>
                        <div class="gci-hero-item">
                            <h4>Actual YTD</h4>
                            <div class="gci-hero-value actual" id="gciActual">$0</div>
                        </div>
                        <div class="gci-hero-item">
                            <h4>Remaining</h4>
                            <div class="gci-hero-value remaining" id="gciRemaining">$0</div>
                        </div>
                        <div class="gci-hero-item">
                            <h4>Pace</h4>
                            <div class="gci-hero-value pace" id="gciPace">0%</div>
                        </div>
                    </div>
                    <div class="gci-progress-container">
                        <div class="gci-progress-label">
                            <span>Progress to Goal</span>
                            <span id="gciProgressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="gciProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Pipeline Header -->
                <div class="pipeline-header">
                    <h3>Active Pipeline</h3>
                    <button class="btn btn-primary" onclick="openDealModal()">+ Add Deal</button>
                </div>
                
                <!-- Pipeline Stages -->
                <div class="pipeline-stages" id="pipelineStages">
                    <!-- Populated by JS -->
                </div>
                
                <!-- Closed Deals Log -->
                <div class="closed-deals-section">
                    <h3>Closed Deals — 2026</h3>
                    <div id="closedDealsContainer">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== TAB 3: ACTIVITY ==================== -->
        <div id="tab-activity" class="tab-content hidden">
            <div class="container">
                <h2>Activity Log</h2>
                
                <!-- Quick Log Bar -->
                <div class="quick-log-bar">
                    <h4>Quick Log — What did you do?</h4>
                    <div class="quick-log-buttons">
                        <button class="quick-log-btn" onclick="quickLog(event, 'conversation')">Conversation</button>
                        <button class="quick-log-btn" onclick="quickLog(event, 'social')">Social Post</button>
                        <button class="quick-log-btn" onclick="quickLog(event, 'openhouse')">Open House</button>
                        <button class="quick-log-btn" onclick="quickLog(event, 'networking')">Networking</button>
                        <button class="quick-log-btn" onclick="quickLog(event, 'doorhanger')">Door Knock</button>
                        <button class="quick-log-btn" onclick="quickLog(event, 'video')">Video</button>
                        <button class="quick-log-btn" onclick="quickLog(event, 'sphere')">Sphere Touch</button>
                        <button class="quick-log-btn" onclick="quickLog(event, 'other')">Other</button>
                    </div>
                </div>
                
                <!-- Post-Log Prompt (shown after logging) -->
                <div id="postLogPrompt" class="post-log-prompt hidden">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <h4 id="postLogTitle">What's your next move?</h4>
                        <button onclick="dismissPostLogPrompt()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.8rem;">Dismiss</button>
                    </div>
                    <p id="postLogDescription" style="margin-bottom: 1rem; color: var(--text-secondary);">Grab a template to keep the momentum going:</p>
                    <div class="prompt-categories" id="postLogCategories">
                        <!-- Populated by JS based on activity type -->
                    </div>
                </div>
                
                <!-- Calendar -->
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button onclick="prevMonth()">←</button>
                        <span class="calendar-month-label" id="calendarMonthLabel">December 2025</span>
                        <button onclick="nextMonth()">→</button>
                    </div>
                    <div class="calendar-stats">
                        <div class="calendar-stat">
                            <div class="calendar-stat-value" id="calDaysActive">0</div>
                            <div class="calendar-stat-label">Days Active</div>
                        </div>
                        <div class="calendar-stat">
                            <div class="calendar-stat-value" id="calConversations">0</div>
                            <div class="calendar-stat-label">Conversations</div>
                        </div>
                        <div class="calendar-stat">
                            <div class="calendar-stat-value" id="calStreak">0</div>
                            <div class="calendar-stat-label">Weeks Active</div>
                        </div>
                    </div>
                </div>
                
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Populated by JS -->
                </div>
                
                <!-- Prompts Library Dropdown -->
                <div class="prompts-dropdown">
                    <div class="prompts-dropdown-header" onclick="togglePromptsDropdown()">
                        <span>AI Prompts Library</span>
                        <span id="promptsDropdownToggle">▼</span>
                    </div>
                    <div class="prompts-dropdown-content" id="promptsDropdownContent">
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
                            Use these with ChatGPT, Claude, or any AI. Your Brand DNA makes them specific to you.
                        </p>
                        <div id="promptsContent">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== TAB 4: REVIEW ==================== -->
        <div id="tab-review" class="tab-content hidden">
            <div class="container">
                <h2>Review & Reflect</h2>
                
                <!-- Review Tabs -->
                <div class="review-tabs">
                    <button class="review-tab active" data-tab="weekly" onclick="switchReviewTab('weekly')">Weekly Close</button>
                    <button class="review-tab" data-tab="monthly" onclick="switchReviewTab('monthly')" id="monthlyTab">Monthly Pulse</button>
                    <button class="review-tab" data-tab="quarterly" onclick="switchReviewTab('quarterly')" id="quarterlyTab">90-Day Review</button>
                    <button class="review-tab" data-tab="standards" onclick="switchReviewTab('standards')" id="standardsTab">14 Standards</button>
                </div>
                
                <!-- Weekly Close -->
                <div id="review-weekly" class="review-panel">
                    <!-- Week Selector -->
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 2rem;">
                        <button class="btn btn-secondary btn-sm" onclick="prevWeek()">← Prev</button>
                        <span id="reviewWeekLabel" style="font-weight: 600; min-width: 150px; text-align: center;">Week 1</span>
                        <button class="btn btn-secondary btn-sm" onclick="nextWeek()">Next →</button>
                    </div>
                    
                    <!-- Execution Metrics -->
                    <div class="review-section">
                        <div class="review-section-title">Execution Metrics</div>
                        <div class="metric-row">
                            <span class="metric-label">Conversations (Target: <span id="weeklyTargetDisplay">15</span>)</span>
                            <input type="number" class="metric-input" id="weekConversations" value="0" onchange="saveWeekData()">
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Appointments Set</span>
                            <input type="number" class="metric-input" id="weekAppointments" value="0" onchange="saveWeekData()">
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Sphere Touches</span>
                            <input type="number" class="metric-input" id="weekSphere" value="0" onchange="saveWeekData()">
                        </div>
                    </div>
                    
                    <!-- Execution Checklist -->
                    <div class="review-section">
                        <div class="review-section-title">Execution Checklist</div>
                        <div id="weeklyChecklist">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Database Health -->
                    <div class="review-section">
                        <div class="review-section-title">🗃️ Database Health</div>
                        <div class="metric-row">
                            <span class="metric-label">Database Size</span>
                            <input type="number" class="metric-input" id="dbSize" value="0" onchange="saveWeekData()">
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Touched This Week</span>
                            <input type="number" class="metric-input" id="dbTouched" value="0" onchange="saveWeekData()">
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Referrals Asked</span>
                            <input type="number" class="metric-input" id="dbReferrals" value="0" onchange="saveWeekData()">
                        </div>
                        <div class="health-meter">
                            <span style="font-size: 0.875rem;">Health:</span>
                            <div class="health-meter-bar">
                                <div class="health-meter-fill" id="dbHealthFill" style="width: 0%"></div>
                            </div>
                            <span class="health-meter-value" id="dbHealthPercent">0%</span>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                            Target: Touch 10%+ of your database weekly
                        </p>
                    </div>
                    
                    <!-- Reflection -->
                    <div class="review-section">
                        <div class="review-section-title">Reflection</div>
                        <div class="form-group">
                            <label>What worked this week?</label>
                            <textarea id="weekWorked" placeholder="What went well?" onchange="saveWeekData()"></textarea>
                        </div>
                        <div class="form-group">
                            <label>What didn't work?</label>
                            <textarea id="weekDidntWork" placeholder="What needs adjustment?" onchange="saveWeekData()"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Gratitude</label>
                            <textarea id="weekGratitude" placeholder="What are you grateful for?" onchange="saveWeekData()"></textarea>
                        </div>
                        <div class="form-group">
                            <label>One sentence truth</label>
                            <textarea id="weekTruth" placeholder="The real reason this week went the way it did was..." onchange="saveWeekData()" style="min-height: 60px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Next week's focus</label>
                            <textarea id="weekNextFocus" placeholder="One priority for next week" onchange="saveWeekData()"></textarea>
                        </div>
                    </div>
                    
                    <!-- Week Counter -->
                    <div class="week-counter">
                        <div>
                            <div class="week-counter-number" id="totalWeeksCompleted">0</div>
                            <div class="week-counter-label">Weeks Completed</div>
                        </div>
                        <button class="btn btn-primary" onclick="markWeekComplete()">✓ Mark Week Complete</button>
                    </div>
                </div>
                
                <!-- Monthly Pulse -->
                <div id="review-monthly" class="review-panel hidden">
                    <div class="review-section">
                        <div class="review-section-title">🫀 Monthly Pulse Check</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            How are you really doing? This isn't about numbers — it's about sustainability.
                        </p>
                        
                        <div class="form-group">
                            <label>Energy Level (1-10)</label>
                            <input type="range" id="monthEnergy" min="1" max="10" value="5" onchange="saveMonthData()">
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted);">
                                <span>Running on empty</span>
                                <span>Fully charged</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Work-Life Balance (1-10)</label>
                            <input type="range" id="monthBalance" min="1" max="10" value="5" onchange="saveMonthData()">
                        </div>
                        
                        <div class="form-group">
                            <label>Confidence in Your Lane (1-10)</label>
                            <input type="range" id="monthConfidence" min="1" max="10" value="5" onchange="saveMonthData()">
                        </div>
                        
                        <div class="form-group">
                            <label>What's weighing on you?</label>
                            <textarea id="monthWeighing" placeholder="Get it off your chest..." onchange="saveMonthData()"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>What's going well?</label>
                            <textarea id="monthWell" placeholder="Celebrate the wins..." onchange="saveMonthData()"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Quarterly Review -->
                <div id="review-quarterly" class="review-panel hidden">
                    <div class="review-section">
                        <div class="review-section-title">90-Day Review</div>
                        
                        <div class="ceo-line" style="margin-bottom: 1.5rem;">
                            Conversations take 3-6 months to convert. You're doing the work. The deals come.
                        </div>
                        
                        <div class="form-group">
                            <label>What lane did you commit to?</label>
                            <p id="quarterLane" style="font-weight: 600; margin-top: 0.5rem;">-</p>
                        </div>
                        
                        <div class="form-group">
                            <label>Did you execute consistently?</label>
                            <textarea id="quarterExecution" placeholder="Be honest with yourself..." onchange="saveQuarterData()"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>What results did you see?</label>
                            <textarea id="quarterResults" placeholder="Deals, conversations, growth..." onchange="saveQuarterData()"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Will you continue this lane for another 90 days?</label>
                            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                <button class="btn btn-secondary" onclick="setQuarterDecision('continue')">Yes, Continue</button>
                                <button class="btn btn-secondary" onclick="setQuarterDecision('change')">No, Change Lanes</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 14 Standards -->
                <div id="review-standards" class="review-panel hidden">
                    <div class="review-section">
                        <div class="review-section-title">The 14 Standards</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                            This is for clarity, not judgment. Check in with yourself.
                        </p>
                        <div id="standardsContainer">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== TAB 5: YOUR LANE ==================== -->
        <div id="tab-lane" class="tab-content hidden">
            <div class="container">
                <h2>Your Lane Setup</h2>
                
                <!-- Build Progress -->
                <div class="build-progress">
                    <span>Setup Progress:</span>
                    <div class="build-progress-bar">
                        <div class="build-progress-fill" id="buildProgressFill" style="width: 0%"></div>
                    </div>
                    <span class="build-progress-text" id="buildProgressText">0%</span>
                </div>
                
                <!-- Build Steps -->
                <div id="buildStepsContainer">
                    <!-- Populated by JS -->
                </div>
                
                <!-- Help Section -->
                <div class="help-section">
                    <h3>❓ Help & FAQ</h3>
                    <div id="helpContainer">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Keyboard Shortcuts -->
                <div class="help-section" style="margin-top: 2rem;">
                    <h3>⌨️ Keyboard Shortcuts</h3>
                    <div style="display: grid; gap: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                        <div><kbd style="background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid var(--card-border);">N</kbd> — New deal</div>
                        <div><kbd style="background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid var(--card-border);">A</kbd> — Log activity</div>
                        <div><kbd style="background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid var(--card-border);">W</kbd> — Weekly review</div>
                        <div><kbd style="background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid var(--card-border);">Esc</kbd> — Close modal</div>
                    </div>
                </div>
                
                <!-- Reset Section -->
                <div class="reset-section">
                    <h4>⚠️ Reset Everything</h4>
                    <p>This will clear all your data and start fresh. This cannot be undone.</p>
                    <button class="btn btn-danger" onclick="confirmReset()">Start Over</button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- ==================== MODALS ==================== -->
    
    <!-- Deal Modal -->
    <div id="dealModal" class="modal-overlay" role="dialog" aria-modal="true hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="dealModalTitle">Add Deal</h3>
                <button class="modal-close" aria-label="Close" onclick="closeDealModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Client Name</label>
                    <input type="text" id="deal_name" placeholder="Client name">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Stage</label>
                        <select id="deal_stage">
                            <option value="lead">Lead</option>
                            <option value="nurturing">Nurturing</option>
                            <option value="active">Active Search</option>
                            <option value="contract">Under Contract</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="deal_type">
                            <option value="buyer">Buyer</option>
                            <option value="seller">Seller</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Expected GCI</label>
                        <input type="text" id="deal_gci" placeholder="$8,000">
                    </div>
                    <div class="form-group">
                        <label>Expected Close Date</label>
                        <input type="date" id="deal_closeDate">
                    </div>
                </div>
                <div class="form-group">
                    <label>Lead Source</label>
                    <input type="text" id="deal_source" placeholder="Sphere, Open House, Social...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="dealDeleteBtn" onclick="deleteDeal()" style="margin-right: auto; display: none;">Delete</button>
                <button class="btn btn-secondary" onclick="closeDealModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveDeal()">Save Deal</button>
            </div>
        </div>
    </div>
    
    <!-- Lane Selector Modal -->
    <div id="laneModal" class="modal-overlay" role="dialog" aria-modal="true hidden">
        <div class="modal">
            <div class="modal-header">
                <h3>Choose Your Lane</h3>
                <button class="modal-close" aria-label="Close" onclick="closeLaneModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    Pick ONE lane and commit for 90 days. Depth beats width.
                </p>
                <div id="laneCommitmentWarning" class="hidden" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                    <strong style="color: var(--warning);">Active commitment</strong><br>
                    <span id="laneWarningText">You're X days into your 90-day commitment.</span><br>
                    <span style="color: var(--text-muted);">Changing lanes resets your progress. Are you sure?</span>
                </div>
                <div id="laneOptions">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLaneModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmLaneChange()">Confirm Lane</button>
            </div>
        </div>
    </div>
    
    <!-- Activity Detail Modal -->
    <div id="activityModal" class="modal-overlay" role="dialog" aria-modal="true hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="activityModalTitle">Log Activity</h3>
                <button class="modal-close" aria-label="Close" onclick="closeActivityModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="activityDate" value="">
                </div>
                <div class="form-group">
                    <label>How many conversations?</label>
                    <input type="number" id="activity_count" min="0" value="1" style="font-size: 1.5rem; text-align: center;">
                </div>
                <div class="form-group">
                    <label>Notes (optional)</label>
                    <textarea id="activity_notes" placeholder="Any details to remember..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeActivityModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveActivity()">Log It</button>
            </div>
        </div>
    </div>
    
    <!-- Prompt Template Modal -->
    <div id="promptModal" class="modal-overlay" role="dialog" aria-modal="true hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="promptModalTitle">Copy Template</h3>
                <button class="modal-close" aria-label="Close" onclick="closePromptModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="prompt-text" id="promptModalContent" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePromptModal()">Close</button>
                <button class="btn btn-primary" onclick="copyPromptFromModal()">Copy to Clipboard</button>
            </div>
        </div>
    </div>
    
    <!-- Day Detail Modal -->
    <div id="dayModal" class="modal-overlay" role="dialog" aria-modal="true hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="dayModalTitle">Day Details</h3>
                <button class="modal-close" aria-label="Close" onclick="closeDayModal()">×</button>
            </div>
            <div class="modal-body">
                <div id="dayModalContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDayModal()">Close</button>
                <button class="btn btn-primary" onclick="addActivityForDay()">+ Add Activity</button>
            </div>
        </div>
    </div>
    
    <!-- Doctrine Modal -->
    <div id="doctrineModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>THE CLOSING LANE™ Doctrine</h3>
            </div>
            <div class="modal-body" style="text-align: left;">
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-style: italic;">
                    This system works because you do.
                </p>
                <div style="line-height: 2; font-size: 1rem;">
                    <p style="margin-bottom: 0.75rem;"><strong>1.</strong> Consistency beats intensity.</p>
                    <p style="margin-bottom: 0.75rem;"><strong>2.</strong> The week is the atomic unit.</p>
                    <p style="margin-bottom: 0.75rem;"><strong>3.</strong> One lane, locked for 90 days.</p>
                    <p style="margin-bottom: 0.75rem;"><strong>4.</strong> Fewer decisions = more execution.</p>
                    <p style="margin-bottom: 0.75rem;"><strong>5.</strong> Progress is its own reward.</p>
                </div>
                <p style="color: var(--text-muted); margin-top: 1.5rem; font-size: 0.85rem;">
                    By continuing, you agree to hold yourself to this standard.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="acceptDoctrine()" style="width: 100%;">I Accept</button>
            </div>
        </div>
    </div>
    
    <!-- Quick Setup Modal -->
    <div id="quickSetupModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <h3>Quick Setup</h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">60 seconds to a working system</p>
            </div>
            <div class="modal-body" style="text-align: left;">
                <div class="form-group" style="margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Your First Name</label>
                    <input type="text" id="setup_name" placeholder="What should we call you?" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--card-border); background: var(--bg); color: var(--text);">
                </div>
                
                <div class="form-group" style="margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Your Lane <span style="color: var(--text-muted); font-weight: normal;">(commit for 90 days)</span></label>
                    <div id="setupLaneOptions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; max-height: 200px; overflow-y: auto; padding: 0.25rem;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Income Goal</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);">$</span>
                            <input type="number" id="setup_income" placeholder="150000" style="width: 100%; padding: 0.75rem 0.75rem 0.75rem 1.75rem; border-radius: 8px; border: 1px solid var(--card-border); background: var(--bg); color: var(--text);">
                        </div>
                        <span style="font-size: 0.75rem; color: var(--text-muted);">Annual target</span>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Avg GCI/Deal</label>
                        <div style="position: relative;">
                            <span style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);">$</span>
                            <input type="number" id="setup_gci" placeholder="8000" style="width: 100%; padding: 0.75rem 0.75rem 0.75rem 1.75rem; border-radius: 8px; border: 1px solid var(--card-border); background: var(--bg); color: var(--text);">
                        </div>
                        <span style="font-size: 0.75rem; color: var(--text-muted);">Per closed deal</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="completeQuickSetup()" style="width: 100%;">Calculate My Numbers →</button>
            </div>
        </div>
    </div>
    
    <!-- Import File Input (hidden) -->
    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
        // ==================== STATE ====================
        let state = {
            profile: {
                incomeGoal: 0,
                avgGci: 8000,
                conversionRate: 20,
                appointmentRate: 33,
            },
            plan: {
                name: '',
                lane: '',
                weekly_conversations: 15,
                workdays_per_week: 5,
                ceo_day: '',
                ceo_time: '',
                business_focus: '',
                who_i_serve: '',
                voice_feels_like: '',
                differentiator: '',
            },
            deals: [],
            weeks: {},
            months: {},
            quarters: {},
            activities: {},
            standards: {},
            currentWeek: 1,
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear(),
            lastVisit: null,
            streak: 0,
            weeksCompleted: 0,
            buildProgress: {},
            lastBackup: null,
            doctrineAccepted: false,
            doctrineAcceptedDate: null,
            quickSetupComplete: false,
            laneSelectedDate: null,
            lastActiveWeek: null,
            ui: { hidePostLogPrompt: false },
            version: '2.1',
        };
        
        let editingDealId = null;
        let selectedLane = null;
        let currentPromptContent = '';
        let selectedDayDate = null;
        let draggedDealId = null;
        
        // ==================== UTILITY FUNCTIONS ====================
        
        // Timezone-safe local date string (fixes UTC vs local issues)
        function localDateStr(date = new Date()) {
            const d = date instanceof Date ? date : new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // XSS protection for user-entered content
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // State migration for backwards compatibility
        function migrateState(loadedState) {
            const currentVersion = '2.1';
            
            // Ensure all required objects exist with correct types
            const defaults = {
                profile: { incomeGoal: 0, avgGci: 8000, conversionRate: 20, appointmentRate: 33 },
                plan: { name: '', lane: '', weekly_conversations: 15, workdays_per_week: 5 },
                deals: [],
                weeks: {},
                months: {},
                quarters: {},
                activities: {},
                standards: {},
                buildProgress: {},
                currentWeek: 1,
                streak: 0,
                weeksCompleted: 0,
                lastBackup: null,
                ui: { hidePostLogPrompt: false, promptsOpen: false },
                doctrineAccepted: false,
                quickSetupComplete: false,
                laneSelectedDate: null,
                schemaVersion: currentVersion,
            };
            
            // Ensure loadedState is an object
            if (!loadedState || typeof loadedState !== 'object') {
                return { ...defaults };
            }
            
            // Deep merge with defaults, ensuring type safety
            for (const key in defaults) {
                const defaultVal = defaults[key];
                const loadedVal = loadedState[key];
                
                if (loadedVal === undefined || loadedVal === null) {
                    loadedState[key] = defaultVal;
                } else if (Array.isArray(defaultVal)) {
                    // Ensure arrays stay arrays
                    loadedState[key] = Array.isArray(loadedVal) ? loadedVal : defaultVal;
                } else if (typeof defaultVal === 'object') {
                    // Ensure objects stay objects and merge with defaults
                    loadedState[key] = typeof loadedVal === 'object' && !Array.isArray(loadedVal) 
                        ? { ...defaultVal, ...loadedVal } 
                        : defaultVal;
                }
            }
            
            // Ensure deals have required fields and valid structure
            if (Array.isArray(loadedState.deals)) {
                loadedState.deals = loadedState.deals.filter(d => d && typeof d === 'object').map(deal => ({
                    id: deal.id || Date.now().toString(),
                    name: deal.name || deal.clientName || '',
                    stage: deal.stage || 'lead',
                    type: deal.type || 'buyer',
                    gci: deal.gci || 0,
                    closeDate: deal.closeDate || '',
                    source: deal.source || '',
                    closedCelebrated: deal.closedCelebrated || false,
                }));
            } else {
                loadedState.deals = [];
            }
            
            // Ensure activities have valid structure
            if (typeof loadedState.activities === 'object' && !Array.isArray(loadedState.activities)) {
                for (const date in loadedState.activities) {
                    const activity = loadedState.activities[date];
                    if (!activity || typeof activity !== 'object') {
                        loadedState.activities[date] = { types: [], conversations: 0, notes: '' };
                    } else {
                        loadedState.activities[date] = {
                            types: Array.isArray(activity.types) ? activity.types : [],
                            conversations: typeof activity.conversations === 'number' ? activity.conversations : 0,
                            notes: activity.notes || '',
                        };
                    }
                }
            }
            
            loadedState.schemaVersion = currentVersion;
            return loadedState;
        }
        
        // ==================== PIPELINE STAGES CONFIG ====================
        const PIPELINE_STAGES = [
            { id: 'lead', name: 'Lead', color: 'var(--text-muted)' },
            { id: 'appointment', name: 'Appointment', color: 'var(--warning)' },
            { id: 'showing', name: 'Showing', color: 'var(--accent)' },
            { id: 'offer', name: 'Offer', color: 'var(--info)' },
            { id: 'pending', name: 'Pending', color: 'var(--secondary)' },
            { id: 'closed', name: 'Closed', color: 'var(--success)' },
        ];
        
        // ==================== LANES DATA ====================
        const LANES = [
            { id: 'sphere', icon: '●', name: 'Sphere of Influence', description: 'Your existing network — friends, family, past clients' },
            { id: 'geographic', icon: '◎', name: 'Geographic Farm', description: 'Dominate a specific neighborhood or area' },
            { id: 'fsbo', icon: '◇', name: 'FSBO & Expired', description: 'For Sale By Owner and expired listings' },
            { id: 'openhouse', icon: '◈', name: 'Open Houses', description: 'Generate leads through open house events' },
            { id: 'firsttime', icon: '★', name: 'First-Time Buyers', description: 'Specialize in first-time homebuyers' },
            { id: 'investor', icon: '◆', name: 'Investors', description: 'Work with real estate investors' },
            { id: 'luxury', icon: '◐', name: 'Luxury', description: 'High-end properties and clientele' },
            { id: 'relocation', icon: '↗', name: 'Relocation', description: 'Help people moving to/from your area' },
            { id: 'divorce', icon: '⚖', name: 'Divorce', description: 'Specialize in divorce real estate' },
            { id: 'probate', icon: '▣', name: 'Probate', description: 'Estate and probate properties' },
            { id: 'veterans', icon: '✦', name: 'Veterans (VA)', description: 'Serve military and veteran buyers' },
            { id: 'social', icon: '◉', name: 'Social Media', description: 'Build your brand through content' },
        ];
        
        // ==================== STANDARDS DATA ====================
        const STANDARDS = [
            { id: 1, title: "I know my lane", description: "I have chosen ONE lane and committed to it for at least 90 days." },
            { id: 2, title: "I know my numbers", description: "I know my Calm Number and work backwards from my income goal." },
            { id: 3, title: "I have a plan", description: "I have set up my CEO Hour and protected time for lead generation." },
            { id: 4, title: "I show up visible", description: "I take visibility actions consistently — people know I'm in real estate." },
            { id: 5, title: "I follow up systematically", description: "I don't let leads slip through the cracks. I have a follow-up system." },
            { id: 6, title: "I track my pipeline", description: "I know exactly what's in my pipeline and expected GCI." },
            { id: 7, title: "I touch my database weekly", description: "I reach out to my sphere consistently, not just when I need business." },
            { id: 8, title: "I ask for referrals", description: "I regularly ask satisfied clients and sphere for referrals." },
            { id: 9, title: "I invest in education", description: "I'm continuously learning and improving my craft." },
            { id: 10, title: "I take care of my health", description: "I protect my physical and mental energy." },
            { id: 11, title: "I have boundaries", description: "I don't let the business consume my life. I have work-life boundaries." },
            { id: 12, title: "I acknowledge completions", description: "I celebrate wins and closed weeks." },
            { id: 13, title: "I learn from losses", description: "When I lose a deal, I reflect and improve." },
            { id: 14, title: "I stay coachable", description: "I remain open to feedback and coaching." },
        ];
        
        // ==================== BUILD STEPS ====================
        const BUILD_STEPS = [
            { id: 1, title: "Before We Begin", fields: ['reflection_why'] },
            { id: 2, title: "Your Identity", fields: ['name', 'email', 'market'] },
            { id: 3, title: "Who You Serve", fields: ['who_i_serve', 'not_for'] },
            { id: 4, title: "Your Voice", fields: ['voice_feels_like'] },
            { id: 5, title: "Your Differentiator", fields: ['differentiator'] },
            { id: 6, title: "Why You?", fields: ['why_you'] },
            { id: 7, title: "Your Origin Story", fields: ['origin_story'] },
            { id: 8, title: "Your Message Framework", fields: ['message_framework'] },
            { id: 9, title: "Your Lane", fields: ['lane'] },
            { id: 10, title: "The Math", fields: ['income_goal', 'avg_gci'] },
            { id: 11, title: "CEO Hour", fields: ['ceo_day', 'ceo_time'] },
            { id: 12, title: "30-Day Focus", fields: ['business_focus'] },
            { id: 13, title: "Non-Negotiables", fields: ['non_negotiables'] },
            { id: 14, title: "Your Commitment", fields: ['commitment'] },
        ];
        
        // ==================== HELP FAQ ====================
        const HELP_FAQ = [
            { q: "What is the Calm Number?", a: "Your Calm Number is the minimum daily conversations needed to hit your income goal. It's calculated from your goals backward. Hit this number daily (or weekly total) and you're on track." },
            { q: "How do I change my lane?", a: "Click on your lane in the Command tab to open the lane selector. We recommend committing to one lane for 90 days before switching." },
            { q: "What counts as a conversation?", a: "A real, two-way exchange about real estate or life. Not a text that got no reply. Not a social media like. Actual dialogue." },
            { q: "How do I export my data?", a: "Click the export button in the header to download a JSON backup of all your data. You can import this later if needed." },
            { q: "Can I use this with my CRM?", a: "Currently, this is a standalone tool. Copy key data to your CRM as needed. CRM integrations are on our roadmap." },
        ];
        
        // ==================== WEEKLY CHECKLIST ====================
        const WEEKLY_CHECKLIST = [
            { id: 'ceo_hour', label: 'Completed CEO Hour this week' },
            { id: 'visibility', label: 'Took at least one visibility action' },
            { id: 'followups', label: 'Followed up with all pending leads' },
            { id: 'target_hit', label: 'Met my weekly conversation standard' },
        ];
        
        // ==================== PROMPT TEMPLATES ====================
        // ==================== TEXT MESSAGE TEMPLATES (10) ====================
        const CONVERSATION_PROMPTS = [
            { id: 'new_lead', title: 'New Lead', template: "Hey [NAME]! Thanks for reaching out about buying a home in {{MARKET}}. I specialize in helping {{WHO_I_SERVE}}. When's a good time for a quick call to learn more about what you're looking for?" },
            { id: 'showing_followup', title: 'Showing Follow-Up', template: "Hey [NAME]! Great meeting you at the showing yesterday. I wanted to check in — any thoughts on [ADDRESS]? Let me know if you'd like to see more options or if you have questions!" },
            { id: 'sphere_touch', title: 'Sphere Touch', template: "Hey [NAME]! Just thinking about you and wanted to say hi. How's everything going? If you ever need anything real estate related (or know someone who does), I'm always here!" },
            { id: 'checking_in', title: 'Just Checking In', template: "Hey [NAME]! It's been a minute — just wanted to check in and see how you're doing! Anything new? Always love catching up with you." },
            { id: 'after_openhouse', title: 'After Open House', template: "Hey [NAME]! Thanks for stopping by the open house at [ADDRESS] today! What did you think? I'd love to help if you're looking — just let me know!" },
            { id: 'referral_ask', title: 'Referral Ask', template: "Hey [NAME]! Random question — do you know anyone thinking about buying or selling a home? I'm growing my business through referrals and would love an intro if someone comes to mind!" },
            { id: 'past_client', title: 'Past Client Check-In', template: "Hey [NAME]! Can you believe it's been [TIME] since we closed on your place? Hope you're loving it! Let me know if you ever need anything — contractor recs, market questions, whatever!" },
            { id: 'market_update', title: 'Market Update Text', template: "Hey [NAME]! Quick {{MARKET}} market update: [INSIGHT]. Thought you'd want to know! Let me know if you have any questions." },
            { id: 'birthday', title: 'Birthday', template: "Happy Birthday [NAME]! 🎂 Hope you have an amazing day! Cheers to another great year ahead!" },
            { id: 'home_anniversary', title: 'Home Anniversary', template: "Hey [NAME]! Happy home-iversary! 🏠 Can you believe it's been [YEARS] since we got you the keys? Hope you're still loving it!" },
        ];
        
        // ==================== SOCIAL MEDIA TEMPLATES (12) ====================
        const SOCIAL_PROMPTS = [
            { id: 'market_update', title: 'Market Update', template: "📊 {{MARKET}} Market Update!\n\nHere's what's happening right now:\n• [STAT 1]\n• [STAT 2]\n• [STAT 3]\n\nWhat this means for you: [INSIGHT]\n\nQuestions? Drop them below! 👇\n\n#{{MARKET}}RealEstate #MarketUpdate" },
            { id: 'just_listed', title: 'Just Listed', template: "🏡 JUST LISTED!\n\n[PROPERTY DESCRIPTION]\n\n✨ [FEATURE 1]\n✨ [FEATURE 2]\n✨ [FEATURE 3]\n\n📍 [LOCATION]\n💰 [PRICE]\n\nKnow someone looking? Tag them! 👇\n\n#JustListed #{{MARKET}}Homes" },
            { id: 'just_sold', title: 'Just Sold', template: "🎉 JUST SOLD!\n\nCongratulations to my amazing clients on their new home!\n\n[BRIEF STORY — what made this special]\n\nReady to be my next success story? Let's talk!\n\n#JustSold #{{MARKET}}RealEstate #HappyClients" },
            { id: 'tip_buyers', title: 'Tip for Buyers', template: "💡 [NUMBER] things every {{WHO_I_SERVE}} should know:\n\n1️⃣ [TIP 1]\n2️⃣ [TIP 2]\n3️⃣ [TIP 3]\n\nSave this for later! 📌\n\nQuestions? I'm here to help!\n\n#HomeBuyingTips #{{MARKET}}RealEstate" },
            { id: 'tip_sellers', title: 'Tip for Sellers', template: "🏠 Thinking about selling? Here's what most agents won't tell you:\n\n[TIP OR INSIGHT]\n\nThe difference between listed and SOLD is strategy.\n\nDM me if you want to know what your home could sell for!\n\n#SellerTips #{{MARKET}}Homes" },
            { id: 'personal_story', title: 'Personal Story', template: "Can I be real with you for a second?\n\n[PERSONAL STORY OR LESSON LEARNED]\n\nThis is why I do what I do. {{WHO_I_SERVE}} deserve someone in their corner.\n\n#RealEstateLife #WhyIDoThisWork" },
            { id: 'testimonial', title: 'Testimonial', template: "🏆 CLIENT WIN!\n\n\"[CLIENT QUOTE]\"\n\n— [CLIENT NAME/INITIALS]\n\nHelping {{WHO_I_SERVE}} is what I do. Ready to write your success story?\n\n#ClientLove #HappyHomeowners" },
            { id: 'behind_scenes', title: 'Behind the Scenes', template: "📸 Behind the scenes today!\n\n[WHAT YOU'RE DOING]\n\n[INSIGHT OR FUN FACT]\n\nThis is what a day in real estate really looks like! 🏠\n\n#DayInTheLife #RealEstateAgent" },
            { id: 'myth_buster', title: 'Myth Buster', template: "🚫 MYTH: [COMMON MISCONCEPTION]\n\n✅ TRUTH: [THE REALITY]\n\nI see this all the time with {{WHO_I_SERVE}}. Don't let bad info hold you back!\n\nWhat other myths have you heard? 👇\n\n#RealEstateMyths #HomeBuyingFacts" },
            { id: 'local_spotlight', title: 'Local Spotlight', template: "📍 {{MARKET}} Spotlight: [LOCAL BUSINESS/SPOT]\n\n[WHY YOU LOVE IT]\n\nThis is why I love living and working here! What are YOUR favorite local spots?\n\n#{{MARKET}}Local #SupportLocal #CommunityLove" },
            { id: 'weekend_openhouse', title: 'Weekend Open House', template: "🏠 OPEN HOUSE this weekend!\n\n📍 [ADDRESS]\n🗓️ [DATE/TIME]\n\n[2-3 HIGHLIGHTS]\n\nCome say hi — no pressure, just good vibes and great real estate! ☕\n\n#OpenHouse #{{MARKET}}Homes" },
            { id: 'q_and_a', title: 'Q&A Post', template: "❓ Question I get asked ALL the time:\n\n\"[COMMON QUESTION]\"\n\nMy answer: [YOUR EXPERT RESPONSE]\n\nWhat questions do YOU have about real estate? Drop them below! 👇\n\n#AskARealtor #{{MARKET}}RealEstate" },
        ];
        
        // ==================== AI PROMPTS (12 across 3 categories) ====================
        const AI_PROMPTS = {
            content: [
                { id: 'social_caption', title: 'Social Media Caption', template: "Write a social media caption for a real estate agent in {{MARKET}} who specializes in {{WHO_I_SERVE}}. The post is about [TOPIC]. Voice should be {{VOICE}}. Keep it under 150 words and include a call to action." },
                { id: 'blog_outline', title: 'Blog Post Outline', template: "Create a blog post outline for a real estate agent serving {{WHO_I_SERVE}} in {{MARKET}}. Topic: [TOPIC]. Include an attention-grabbing headline, 5 main sections with subpoints, and a conclusion with CTA. Tone: {{VOICE}}." },
                { id: 'video_script', title: 'Video Script', template: "Write a 60-second video script for a real estate agent in {{MARKET}}. Topic: [TOPIC]. Audience: {{WHO_I_SERVE}}. Start with a hook, deliver value, end with CTA. Tone should be {{VOICE}}." },
                { id: 'email_newsletter', title: 'Email Newsletter', template: "Write a monthly email newsletter for a real estate agent's sphere. Market: {{MARKET}}. Include: market update section, one helpful tip, personal touch, and soft CTA. Voice: {{VOICE}}. Target audience: {{WHO_I_SERVE}}." },
            ],
            client: [
                { id: 'buyer_objection', title: 'Handle Buyer Objection', template: "I'm a real estate agent helping {{WHO_I_SERVE}} in {{MARKET}}. A buyer just said: \"[OBJECTION]\". Give me 3 ways to respond that are {{VOICE}} and address their real concern." },
                { id: 'seller_objection', title: 'Handle Seller Objection', template: "I'm a real estate agent in {{MARKET}}. A potential seller said: \"[OBJECTION]\". Give me a response that's empathetic, addresses the concern, and positions my value. My differentiator: {{DIFFERENTIATOR}}." },
                { id: 'listing_presentation', title: 'Listing Presentation Points', template: "Give me 5 compelling points for a listing presentation to a [TYPE] seller in {{MARKET}}. My unique value: {{DIFFERENTIATOR}}. Help me stand out from other agents." },
                { id: 'negotiation_strategy', title: 'Negotiation Strategy', template: "I'm representing a [BUYER/SELLER] in {{MARKET}}. Situation: [DESCRIBE]. Give me 3 negotiation strategies to get the best outcome for my client." },
            ],
            planning: [
                { id: 'weekly_content', title: 'Weekly Content Plan', template: "Create a 5-day social media content plan for a real estate agent in {{MARKET}}. Lane/focus: {{LANE}}. Audience: {{WHO_I_SERVE}}. Include post type, topic, and hook for each day. Voice: {{VOICE}}." },
                { id: 'sphere_campaign', title: 'Sphere Campaign', template: "Design a 4-week sphere of influence campaign for a real estate agent. Goal: stay top of mind without being salesy. Include touchpoints across text, email, social, and calls. Tone: {{VOICE}}." },
                { id: 'quarterly_goals', title: 'Quarterly Goal Breakdown', template: "Help me break down my quarterly goal. Income target: ${{INCOME_GOAL}}. Average GCI: ${{AVG_GCI}}. Current focus: {{FOCUS}}. Give me monthly milestones and weekly activities to hit this goal." },
                { id: 'lead_gen_ideas', title: 'Lead Gen Ideas', template: "Give me 10 creative lead generation ideas for a real estate agent in {{MARKET}} focusing on {{LANE}}. Target audience: {{WHO_I_SERVE}}. Mix of online and offline. I can commit to {{WEEKLY_TARGET}} conversations per week." },
            ],
        };
        
        // ==================== BRAND DNA PERSONALIZATION ====================
        function personalizeTemplate(str) {
            return str
                .replace(/\{\{MARKET\}\}/g, state.plan.market || '[YOUR MARKET]')
                .replace(/\{\{WHO_I_SERVE\}\}/g, state.plan.who_i_serve || '[YOUR AUDIENCE]')
                .replace(/\{\{VOICE\}\}/g, state.plan.voice_feels_like || '[YOUR VOICE]')
                .replace(/\{\{DIFFERENTIATOR\}\}/g, state.plan.differentiator || '[YOUR DIFFERENTIATOR]')
                .replace(/\{\{LANE\}\}/g, LANES.find(l => l.id === state.plan.lane)?.name || '[YOUR LANE]')
                .replace(/\{\{WEEKLY_TARGET\}\}/g, state.plan.weekly_conversations || '15')
                .replace(/\{\{INCOME_GOAL\}\}/g, state.profile.incomeGoal || '[INCOME GOAL]')
                .replace(/\{\{AVG_GCI\}\}/g, state.profile.avgGci || '[AVG GCI]')
                .replace(/\{\{FOCUS\}\}/g, state.plan.business_focus || '[YOUR FOCUS]');
        }
        
        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', function() {
            loadState();
            initApp();
            initPromptsDropdown();
            
            // Global keyboard handlers
            document.addEventListener('keydown', function(e) {
                // Skip if user is typing in an input/textarea
                if (e.target.matches('input, textarea, select')) return;
                
                if (e.key === 'Escape') {
                    closeAllModals();
                }
                
                // Keyboard shortcuts (when not in modal)
                const anyModalOpen = document.querySelector('.modal-overlay:not(.hidden)');
                if (!anyModalOpen) {
                    if (e.key === 'n' || e.key === 'N') {
                        e.preventDefault();
                        openDealModal();
                    } else if (e.key === 'a' || e.key === 'A') {
                        e.preventDefault();
                        document.getElementById('activityModal').classList.remove('hidden');
                        document.getElementById('activityDate').value = localDateStr();
                    } else if (e.key === 'w' || e.key === 'W') {
                        e.preventDefault();
                        switchTab('review');
                        switchReviewTab('weekly');
                    }
                }
            });
            
            // Click outside modal to close
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        overlay.classList.add('hidden');
                    }
                });
            });
        });
        
        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden'));
            editingDealId = null;
        }
        
        function loadState() {
            const saved = localStorage.getItem('closingLaneState_v2');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = migrateState({ ...state, ...parsed });
                } catch(e) {
                    console.error('Failed to parse saved state', e);
                }
            }
        }
        
        function saveState() {
            state.lastVisit = new Date().toISOString();
            try {
                localStorage.setItem('closingLaneState_v2', JSON.stringify(state));
            } catch (e) {
                // Safari private mode, storage quota exceeded, etc.
                showNotification('Storage unavailable. Export backup now.');
                console.error('Storage error:', e);
            }
        }
        
        function initApp() {
            calculateCurrentWeek();
            updateCommandCenter();
            renderPipeline();
            renderCalendar();
            renderPrompts();
            renderReview();
            renderBuildSteps();
            renderStandards();
            renderHelp();
            checkWelcomeBack();
            checkStreak();
            checkBackupReminder();
            checkFirstTimeUser();
            checkLaneCommitment();
            checkMissedWeeks();
            
            // Check for saved theme
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light-mode');
            }
        }
        
        // ==================== TABS ====================
        function switchTab(tabId) {
            // Update desktop tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const isActive = btn.textContent.toLowerCase().includes(tabId) || 
                    (tabId === 'lane' && btn.textContent.includes('Lane')) ||
                    (tabId === 'command' && btn.textContent.includes('Command'));
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });
            
            // Update mobile nav buttons
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                const btnTab = btn.getAttribute('onclick').match(/'([^']+)'/)?.[1];
                btn.classList.toggle('active', btnTab === tabId);
            });
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            
            // Refresh content if needed
            if (tabId === 'command') updateCommandCenter();
            if (tabId === 'deals') renderPipeline();
            if (tabId === 'activity') renderCalendar();
            if (tabId === 'review') renderReview();
            if (tabId === 'lane') renderBuildSteps();
        }
        
        // ==================== COMMAND CENTER ====================
        function calculateCurrentWeek() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 1);
            const diff = now - start;
            const oneWeek = 1000 * 60 * 60 * 24 * 7;
            state.currentWeek = Math.ceil(diff / oneWeek);
        }
        
        function updateCommandCenter() {
            // User name
            const nameSpan = document.getElementById('userName');
            if (state.plan.name) {
                nameSpan.textContent = `, ${state.plan.name.split(' ')[0]}`;
            }
            
            // Week position
            document.getElementById('weekPosition').textContent = `Week ${state.currentWeek} of 52 • ${new Date().getFullYear()}`;
            
            // Lane display
            if (state.plan.lane) {
                const lane = LANES.find(l => l.id === state.plan.lane);
                if (lane) {
                    document.getElementById('currentLaneIcon').textContent = lane.icon;
                    document.getElementById('currentLaneName').textContent = lane.name;
                    
                    // Calculate days in lane
                    const laneStatus = document.getElementById('laneStatus');
                    if (state.plan.laneStartDate) {
                        const startDate = new Date(state.plan.laneStartDate);
                        const now = new Date();
                        const daysIn = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                        const daysRemaining = Math.max(0, 90 - daysIn);
                        
                        if (daysRemaining > 0) {
                            laneStatus.textContent = `Day ${daysIn + 1} of 90 • ${daysRemaining} days remaining`;
                        } else {
                            laneStatus.textContent = `90 days complete • Commitment honored`;
                        }
                    } else {
                        laneStatus.textContent = 'Click to change →';
                    }
                }
            } else {
                document.getElementById('laneStatus').textContent = 'Click to select →';
            }
            
            // Weekly target
            const weeklyTarget = state.plan.weekly_conversations || 15;
            const weekKey = `week_${state.currentWeek}`;
            const weekData = state.weeks[weekKey] || {};
            const weeklyLogged = weekData.conversations || 0;
            
            document.getElementById('weeklyTargetNumber').textContent = weeklyTarget;
            document.getElementById('weeklyTarget').textContent = weeklyTarget;
            document.getElementById('weeklyLogged').textContent = weeklyLogged;
            
            const progress = Math.min((weeklyLogged / weeklyTarget) * 100, 100);
            const progressBar = document.getElementById('weeklyProgressBar');
            progressBar.style.width = `${progress}%`;
            if (progress >= 100) {
                progressBar.classList.add('complete');
            } else {
                progressBar.classList.remove('complete');
            }
            
            // Calculate pace
            const dayOfWeek = new Date().getDay() || 7; // 1-7, Mon=1
            const daysLeft = 7 - dayOfWeek;
            const remaining = weeklyTarget - weeklyLogged;
            let paceText = '';
            if (remaining <= 0) {
                paceText = '✓ Standard met';
            } else if (daysLeft === 0) {
                paceText = `${remaining} left today`;
            } else {
                const perDay = Math.ceil(remaining / daysLeft);
                paceText = `~${perDay}/day for ${daysLeft} days`;
            }
            document.getElementById('weeklyPace').textContent = paceText;
            
            // Show confirmation banner if weekly standard met
            if (weeklyLogged >= weeklyTarget && !weekData.celebrated) {
                document.getElementById('celebrationBanner').classList.remove('hidden');
                // No confetti here — save it for major milestones
                weekData.celebrated = true;
                state.weeks[weekKey] = weekData;
                saveState();
            }
            
            // Status cards
            const calmNumber = calculateCalmNumber();
            document.getElementById('calmNumber').textContent = calmNumber;
            document.getElementById('thisWeekConvos').textContent = weeklyLogged;
            document.getElementById('weeksCompleted').textContent = state.weeksCompleted || 0;
            
            const pipelineCount = state.deals.filter(d => d.stage !== 'closed').length;
            document.getElementById('pipelineCount').textContent = pipelineCount;
            
            const ytdGci = calculateYtdGci();
            document.getElementById('ytdGci').textContent = formatCurrency(ytdGci);
            
            // Quick reference
            const lane = LANES.find(l => l.id === state.plan.lane);
            document.getElementById('qrLane').textContent = lane ? lane.name : 'Not set';
            document.getElementById('qrCalm').textContent = `${calmNumber} conversations/day`;
            document.getElementById('qrCeo').textContent = state.plan.ceo_day && state.plan.ceo_time ? 
                `${state.plan.ceo_day} at ${state.plan.ceo_time}` : 'Not set';
            document.getElementById('qrFocus').textContent = state.plan.business_focus || 'Not set';
            
            // Next action
            updateNextAction(weeklyLogged, weeklyTarget);
        }
        
        function calculateCalmNumber() {
            // Validate inputs with reasonable defaults and minimums
            const income = Math.max(state.profile.incomeGoal || 100000, 10000);
            const avgGci = Math.max(state.profile.avgGci || 8000, 1000);
            const convRate = Math.min(Math.max(state.profile.conversionRate || 20, 1), 100);
            const apptRate = Math.min(Math.max(state.profile.appointmentRate || 33, 1), 100);
            
            const dealsNeeded = Math.ceil(income / avgGci);
            const apptsNeeded = Math.ceil(dealsNeeded / (apptRate / 100));
            const convosNeeded = Math.ceil(apptsNeeded / (convRate / 100));
            const weeklyConvos = Math.max(Math.ceil(convosNeeded / 50), 1);
            const dailyConvos = Math.max(Math.ceil(weeklyConvos / 5), 1);
            
            state.plan.weekly_conversations = weeklyConvos;
            return dailyConvos;
        }
        
        function updateNextAction(logged, target) {
            const icon = document.querySelector('.next-action-icon');
            const text = document.getElementById('nextActionText');
            
            if (logged >= target) {
                icon.textContent = '✓';
                text.textContent = "Weekly standard met. Consistency confirmed.";
            } else if (logged === 0) {
                icon.textContent = '→';
                text.textContent = "Start your week strong — log your first conversation.";
            } else {
                const remaining = target - logged;
                icon.textContent = '◉';
                text.textContent = `${remaining} more conversations to hit your weekly target.`;
            }
        }
        
        function checkWelcomeBack() {
            if (state.lastVisit) {
                const last = new Date(state.lastVisit);
                const now = new Date();
                const daysDiff = Math.floor((now - last) / (1000 * 60 * 60 * 24));
                
                if (daysDiff >= 14) {
                    document.getElementById('welcomeBackBanner').classList.remove('hidden');
                }
            }
        }
        
        function checkStreak() {
            // Calculate streak based on weeks completed
            let streak = 0;
            const currentWeek = state.currentWeek;
            
            for (let w = currentWeek - 1; w >= 1; w--) {
                const weekData = state.weeks[`week_${w}`];
                if (weekData && weekData.completed) {
                    streak++;
                } else {
                    break;
                }
            }
            
            state.streak = streak;
            
            if (streak >= 2) {
                document.getElementById('streakBadge').classList.remove('hidden');
                document.getElementById('streakCount').textContent = streak;
            }
        }
        
        // ==================== BACKUP REMINDER ====================
        function checkBackupReminder() {
            const lastBackup = state.lastBackup ? new Date(state.lastBackup) : null;
            const now = new Date();
            const daysSinceBackup = lastBackup ? Math.floor((now - lastBackup) / (1000 * 60 * 60 * 24)) : 999;
            
            if (daysSinceBackup >= 7) {
                document.getElementById('backupReminder').classList.remove('hidden');
            }
        }
        
        function dismissBackupReminder() {
            document.getElementById('backupReminder').classList.add('hidden');
        }
        
        // ==================== LANE COMMITMENT CHECK ====================
        function checkLaneCommitment() {
            // Check if 90 days have passed since lane selection
            if (!state.laneSelectedDate || !state.plan.lane) return;
            
            const selectedDate = new Date(state.laneSelectedDate);
            const now = new Date();
            const daysSinceLaneSelected = Math.floor((now - selectedDate) / (1000 * 60 * 60 * 24));
            
            // If 90+ days, prompt for quarterly review
            if (daysSinceLaneSelected >= 90) {
                const quarterKey = `q_${Math.ceil(state.currentWeek / 13)}`;
                if (!state.quarters[quarterKey]?.decision) {
                    // Highlight quarterly review tab
                    document.getElementById('quarterlyTab')?.classList.add('needs-attention');
                }
            }
        }
        
        function checkMissedWeeks() {
            // Check if user missed logging last week
            const lastWeek = state.currentWeek - 1;
            if (lastWeek > 0) {
                const lastWeekKey = `week_${lastWeek}`;
                const lastWeekData = state.weeks[lastWeekKey];
                
                // If last week has no data and wasn't marked complete, it's a missed week
                if (!lastWeekData?.completed && !lastWeekData?.conversations) {
                    // Could show a gentle reminder, but keeping it quiet per doctrine
                }
            }
        }
        
        // ==================== DAY DETAIL MODAL ====================
        function openDayModal(dateStr) {
            selectedDayDate = dateStr;
            const dayActivities = state.activities[dateStr] || [];
            
            const date = new Date(dateStr + 'T12:00:00');
            const formatted = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            
            document.getElementById('dayModalTitle').textContent = formatted;
            
            let content = '';
            
            if (dayActivities.length === 0) {
                content = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No activities logged for this day.</p>';
            } else {
                // Group by type
                const byType = {};
                dayActivities.forEach(a => {
                    if (!byType[a.type]) byType[a.type] = [];
                    byType[a.type].push(a);
                });
                
                content = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
                
                for (const [type, activities] of Object.entries(byType)) {
                    const typeLabels = {
                        conversation: 'Conversations',
                        appointment: 'Appointments', 
                        sphere: 'Sphere Touches',
                        showing: 'Showings',
                        offer: 'Offers',
                        closing: 'Closings'
                    };
                    
                    content += `<div style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem;">
                        <h4 style="margin-bottom: 0.5rem;">${typeLabels[type] || type} (${activities.length})</h4>
                        <ul style="margin: 0; padding-left: 1.25rem; color: var(--text-secondary);">`;
                    
                    activities.forEach(a => {
                        content += `<li>${a.notes || 'No notes'}</li>`;
                    });
                    
                    content += '</ul></div>';
                }
                
                content += '</div>';
            }
            
            document.getElementById('dayModalContent').innerHTML = content;
            document.getElementById('dayModal').classList.remove('hidden');
        }
        
        function closeDayModal() {
            document.getElementById('dayModal').classList.add('hidden');
            selectedDayDate = null;
        }
        
        function addActivityForDay() {
            closeDayModal();
            // Switch to activity tab and open modal
            switchTab('activity');
            setTimeout(() => {
                document.getElementById('activityModal').classList.remove('hidden');
                if (selectedDayDate) {
                    document.getElementById('activityDate').value = selectedDayDate;
                }
            }, 100);
        }
        
        // ==================== LANE SELECTOR ====================
        function openLaneSelector() {
            const container = document.getElementById('laneOptions');
            container.innerHTML = LANES.map(lane => `
                <div class="lane-option ${state.plan.lane === lane.id ? 'selected' : ''}" 
                     onclick="selectLane('${lane.id}')" data-lane="${lane.id}">
                    <span class="lane-option-icon">${lane.icon}</span>
                    <div class="lane-option-info">
                        <h4>${lane.name}</h4>
                        <p>${lane.description}</p>
                    </div>
                </div>
            `).join('');
            
            // Show commitment warning if within 90 days
            const warningEl = document.getElementById('laneCommitmentWarning');
            if (state.plan.lane && state.plan.laneStartDate) {
                const startDate = new Date(state.plan.laneStartDate);
                const now = new Date();
                const daysIn = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                
                if (daysIn < 90) {
                    document.getElementById('laneWarningText').textContent = 
                        `You're ${daysIn + 1} days into your 90-day commitment.`;
                    warningEl.classList.remove('hidden');
                } else {
                    warningEl.classList.add('hidden');
                }
            } else {
                warningEl.classList.add('hidden');
            }
            
            selectedLane = state.plan.lane;
            document.getElementById('laneModal').classList.remove('hidden');
        }
        
        function selectLane(laneId) {
            selectedLane = laneId;
            document.querySelectorAll('.lane-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.lane === laneId);
            });
        }
        
        function confirmLaneChange() {
            if (selectedLane) {
                // Track when lane was selected for 90-day commitment
                if (state.plan.lane !== selectedLane) {
                    state.plan.laneStartDate = new Date().toISOString();
                }
                state.plan.lane = selectedLane;
                saveState();
                closeLaneModal();
                updateCommandCenter();
                showNotification('Lane updated');
            }
        }
        
        function closeLaneModal() {
            document.getElementById('laneModal').classList.add('hidden');
        }
        
        // ==================== DEALS & PIPELINE ====================
        function renderPipeline() {
            const stages = ['lead', 'nurturing', 'active', 'contract', 'closed'];
            const stageNames = {
                lead: 'Lead',
                nurturing: 'Nurturing',
                active: 'Active Search',
                contract: 'Under Contract',
                closed: 'Closed'
            };
            
            const container = document.getElementById('pipelineStages');
            container.innerHTML = stages.filter(s => s !== 'closed').map(stage => {
                const deals = state.deals.filter(d => d.stage === stage);
                const stageGci = deals.reduce((sum, d) => sum + parseGci(d.gci), 0);
                
                return `
                    <div class="pipeline-stage" data-stage="${stage}"
                         ondragover="handleDragOver(event)" 
                         ondragleave="handleDragLeave(event)" 
                         ondrop="handleDrop(event, '${stage}')">
                        <div class="stage-header">
                            <div>
                                <div class="stage-title">${stageNames[stage]}</div>
                                ${stageGci > 0 ? `<div class="stage-gci">${formatCurrency(stageGci)} projected</div>` : ''}
                            </div>
                            <span class="stage-count">${deals.length}</span>
                        </div>
                        <div class="stage-deals">
                            ${deals.map(deal => `
                                <div class="deal-card" 
                                     draggable="true"
                                     ondragstart="handleDragStart(event, '${deal.id}')"
                                     ondragend="handleDragEnd(event)"
                                     onclick="editDeal('${deal.id}')">
                                    <div class="deal-name">${escapeHtml(deal.name)}</div>
                                    <div class="deal-meta">
                                        <span>${escapeHtml(deal.type)}</span>
                                        <span class="deal-gci">${escapeHtml(deal.gci)}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="stage-add" onclick="openDealModal('${stage}')">+ Add Deal</button>
                    </div>
                `;
            }).join('');
            
            // Closed deals
            const closedDeals = state.deals.filter(d => d.stage === 'closed');
            const closedContainer = document.getElementById('closedDealsContainer');
            
            if (closedDeals.length === 0) {
                closedContainer.innerHTML = `
                    <p style="color: var(--text-muted); text-align: center; padding: 2rem;">
                        No closed deals yet. Keep going — your first close is coming.
                    </p>
                `;
            } else {
                const totalGci = closedDeals.reduce((sum, d) => sum + parseGci(d.gci), 0);
                closedContainer.innerHTML = `
                    <table class="closed-deals-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Type</th>
                                <th>Source</th>
                                <th>GCI</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${closedDeals.map(deal => `
                                <tr onclick="editDeal('${deal.id}')" style="cursor: pointer;">
                                    <td>${escapeHtml(deal.closeDate) || '-'}</td>
                                    <td>${escapeHtml(deal.name)}</td>
                                    <td>${escapeHtml(deal.type)}</td>
                                    <td>${escapeHtml(deal.source) || '-'}</td>
                                    <td class="gci-cell">${escapeHtml(deal.gci)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align: right; font-weight: 600;">Total:</td>
                                <td class="gci-cell">${formatCurrency(totalGci)}</td>
                            </tr>
                        </tfoot>
                    </table>
                `;
            }
            
            // GCI Hero
            updateGciHero();
        }
        
        function updateGciHero() {
            const goal = state.profile.incomeGoal || 100000;
            const actual = calculateYtdGci();
            const remaining = Math.max(0, goal - actual);
            
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 1);
            const end = new Date(now.getFullYear(), 11, 31);
            const totalDays = (end - start) / (1000 * 60 * 60 * 24);
            const daysPassed = (now - start) / (1000 * 60 * 60 * 24);
            const expectedProgress = daysPassed / totalDays;
            const actualProgress = actual / goal;
            const pace = expectedProgress > 0 ? Math.round((actualProgress / expectedProgress) * 100) : 0;
            
            document.getElementById('gciGoal').textContent = formatCurrency(goal);
            document.getElementById('gciActual').textContent = formatCurrency(actual);
            document.getElementById('gciRemaining').textContent = formatCurrency(remaining);
            document.getElementById('gciPace').textContent = `${pace}%`;
            
            const progressPercent = Math.min((actual / goal) * 100, 100);
            document.getElementById('gciProgressPercent').textContent = `${Math.round(progressPercent)}%`;
            document.getElementById('gciProgressBar').style.width = `${progressPercent}%`;
        }
        
        function calculateYtdGci() {
            const currentYear = new Date().getFullYear();
            return state.deals
                .filter(d => d.stage === 'closed')
                .filter(d => {
                    if (!d.closeDate) return true;
                    return new Date(d.closeDate).getFullYear() === currentYear;
                })
                .reduce((sum, d) => sum + parseGci(d.gci), 0);
        }
        
        function parseGci(gciStr) {
            if (!gciStr) return 0;
            return parseInt(gciStr.replace(/[^0-9]/g, '')) || 0;
        }
        
        function formatCurrency(num) {
            return '$' + num.toLocaleString();
        }
        
        function openDealModal(stage = 'lead') {
            editingDealId = null;
            document.getElementById('dealModalTitle').textContent = 'Add Deal';
            document.getElementById('deal_name').value = '';
            document.getElementById('deal_stage').value = stage;
            document.getElementById('deal_type').value = 'buyer';
            document.getElementById('deal_gci').value = '';
            document.getElementById('deal_closeDate').value = '';
            document.getElementById('deal_source').value = '';
            document.getElementById('dealDeleteBtn').style.display = 'none';
            document.getElementById('dealModal').classList.remove('hidden');
        }
        
        function editDeal(dealId) {
            const deal = state.deals.find(d => d.id === dealId);
            if (!deal) return;
            
            editingDealId = dealId;
            document.getElementById('dealModalTitle').textContent = 'Edit Deal';
            document.getElementById('deal_name').value = deal.name;
            document.getElementById('deal_stage').value = deal.stage;
            document.getElementById('deal_type').value = deal.type;
            document.getElementById('deal_gci').value = deal.gci;
            document.getElementById('deal_closeDate').value = deal.closeDate || '';
            document.getElementById('deal_source').value = deal.source || '';
            document.getElementById('dealDeleteBtn').style.display = 'block';
            document.getElementById('dealModal').classList.remove('hidden');
        }
        
        function saveDeal() {
            const name = document.getElementById('deal_name').value.trim();
            if (!name) {
                alert('Please enter a client name');
                return;
            }
            
            const deal = {
                id: editingDealId || Date.now().toString(),
                name: name,
                stage: document.getElementById('deal_stage').value,
                type: document.getElementById('deal_type').value,
                gci: document.getElementById('deal_gci').value,
                closeDate: document.getElementById('deal_closeDate').value,
                source: document.getElementById('deal_source').value,
            };
            
            if (editingDealId) {
                const idx = state.deals.findIndex(d => d.id === editingDealId);
                if (idx >= 0) {
                    // Preserve closedCelebrated flag when editing
                    deal.closedCelebrated = state.deals[idx].closedCelebrated;
                    state.deals[idx] = deal;
                }
            } else {
                state.deals.push(deal);
            }
            
            // Check if deal just closed (and hasn't been celebrated)
            if (deal.stage === 'closed' && !deal.closedCelebrated) {
                deal.closedCelebrated = true;
                triggerConfetti();
                showNotification('Deal closed.');
            }
            
            saveState();
            closeDealModal();
            renderPipeline();
            updateCommandCenter();
        }
        
        function deleteDeal() {
            if (!editingDealId) return;
            if (!confirm('Delete this deal?')) return;
            
            state.deals = state.deals.filter(d => d.id !== editingDealId);
            saveState();
            closeDealModal();
            renderPipeline();
            updateCommandCenter();
        }
        
        function closeDealModal() {
            document.getElementById('dealModal').classList.add('hidden');
            editingDealId = null;
        }
        
        // ==================== DRAG AND DROP ====================
        function handleDragStart(event, dealId) {
            draggedDealId = dealId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', dealId.toString());
        }
        
        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            draggedDealId = null;
            document.querySelectorAll('.pipeline-stage').forEach(s => s.classList.remove('drag-over'));
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        function handleDrop(event, newStage) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            // Fallback to dataTransfer if global draggedDealId is missing (Safari)
            const dealId = draggedDealId || parseInt(event.dataTransfer.getData('text/plain'));
            
            if (dealId) {
                const deal = state.deals.find(d => d.id === dealId);
                if (deal && deal.stage !== newStage) {
                    const stageName = PIPELINE_STAGES.find(s => s.id === newStage)?.name || newStage;
                    deal.stage = newStage;
                    saveState();
                    renderPipeline();
                    updateCommandCenter();
                    showNotification(`Deal moved to ${stageName}`);
                    
                    // Trigger confetti if moved to closed
                    if (newStage === 'closed' && !deal.closedCelebrated) {
                        deal.closedCelebrated = true;
                        saveState();
                        triggerConfetti();
                    }
                }
            }
        }
        
        // ==================== ACTIVITY & CALENDAR ====================
        function quickLog(evt, type) {
            // Highlight the button
            document.querySelectorAll('.quick-log-btn').forEach(btn => btn.classList.remove('active'));
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add('active');
            }
            
            if (type === 'conversation') {
                document.getElementById('activityModal').classList.remove('hidden');
                document.getElementById('activityDate').value = localDateStr();
            } else {
                // Log the activity directly
                const today = localDateStr();
                if (!state.activities[today]) {
                    state.activities[today] = { types: [], conversations: 0, notes: '' };
                }
                // Keep types unique using Set (also cleans any existing duplicates)
                state.activities[today].types = [...new Set([...state.activities[today].types, type])];
                saveState();
                
                showNotification('Activity logged');
                renderCalendar();
                updateCommandCenter();
                showPostLogPrompt(type);
            }
        }
        
        function saveActivity() {
            const count = parseInt(document.getElementById('activity_count').value) || 0;
            const notes = document.getElementById('activity_notes').value;
            const dateInput = document.getElementById('activityDate').value;
            const activityDate = dateInput || localDateStr();
            
            if (!state.activities[activityDate]) {
                state.activities[activityDate] = { types: [], conversations: 0, notes: '' };
            }
            state.activities[activityDate].conversations += count;
            // Keep types unique (no duplicates)
            if (!state.activities[activityDate].types.includes('conversation')) {
                state.activities[activityDate].types.push('conversation');
            }
            if (notes) state.activities[activityDate].notes += (state.activities[activityDate].notes ? '\n' : '') + notes;
            
            // Update weekly conversations
            const weekKey = `week_${state.currentWeek}`;
            if (!state.weeks[weekKey]) state.weeks[weekKey] = {};
            state.weeks[weekKey].conversations = (state.weeks[weekKey].conversations || 0) + count;
            
            saveState();
            closeActivityModal();
            
            showNotification(`${count} conversation${count !== 1 ? 's' : ''} logged`);
            renderCalendar();
            updateCommandCenter();
            showPostLogPrompt('conversation');
        }
        
        function closeActivityModal() {
            document.getElementById('activityModal').classList.add('hidden');
            document.getElementById('activity_count').value = 1;
            document.getElementById('activity_notes').value = '';
            document.getElementById('activityDate').value = localDateStr();
        }
        
        function showPostLogPrompt(type) {
            // Check if user has dismissed post-log prompts
            if (state.ui?.hidePostLogPrompt) return;
            
            const promptDiv = document.getElementById('postLogPrompt');
            const titleEl = document.getElementById('postLogTitle');
            const descEl = document.getElementById('postLogDescription');
            const categoriesEl = document.getElementById('postLogCategories');
            
            let prompts = [];
            
            if (type === 'conversation' || type === 'sphere' || type === 'networking') {
                titleEl.textContent = 'Need a follow-up text?';
                descEl.textContent = 'Grab a template to keep the conversation going:';
                prompts = CONVERSATION_PROMPTS;
            } else if (type === 'social' || type === 'video') {
                titleEl.textContent = 'Need content ideas?';
                descEl.textContent = 'Grab a social media template:';
                prompts = SOCIAL_PROMPTS;
            } else {
                promptDiv.classList.add('hidden');
                return;
            }
            
            categoriesEl.innerHTML = prompts.map(p => `
                <button class="prompt-category-btn" onclick="showPromptTemplate('${p.id}', '${type === 'social' || type === 'video' ? 'social' : 'text'}')">
                    ${p.title}
                </button>
            `).join('');
            
            promptDiv.classList.remove('hidden');
        }
        
        function dismissPostLogPrompt() {
            state.ui = state.ui || {};
            state.ui.hidePostLogPrompt = true;
            saveState();
            document.getElementById('postLogPrompt').classList.add('hidden');
        }
        
        function showPromptTemplate(promptId, type, category = null) {
            let prompt;
            
            if (category) {
                // AI prompt
                prompt = AI_PROMPTS[category]?.find(p => p.id === promptId);
            } else {
                const prompts = type === 'social' ? SOCIAL_PROMPTS : CONVERSATION_PROMPTS;
                prompt = prompts.find(p => p.id === promptId);
            }
            
            if (!prompt) return;
            
            // Personalize template with Brand DNA
            let template = personalizeTemplate(prompt.template);
            
            currentPromptContent = template;
            document.getElementById('promptModalTitle').textContent = prompt.title;
            document.getElementById('promptModalContent').textContent = template;
            document.getElementById('promptModal').classList.remove('hidden');
        }
        
        function copyPromptFromModal() {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(currentPromptContent).then(() => {
                    showNotification('Copied to clipboard');
                }).catch(() => {
                    fallbackCopy(currentPromptContent);
                });
            } else {
                fallbackCopy(currentPromptContent);
            }
        }
        
        function fallbackCopy(text) {
            // Fallback for non-HTTPS or older browsers
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showNotification('Copied to clipboard');
            } catch (e) {
                showNotification('Copy failed. Select and copy manually.');
            }
            document.body.removeChild(textarea);
        }
        
        function closePromptModal() {
            document.getElementById('promptModal').classList.add('hidden');
        }
        
        function renderCalendar() {
            const year = state.calendarYear;
            const month = state.calendarMonth;
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonthLabel').textContent = `${monthNames[month]} ${year}`;
            
            // Calculate stats
            let daysActive = 0;
            let monthConversations = 0;
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const activity = state.activities[dateStr];
                if (activity && (activity.types.length > 0 || activity.conversations > 0)) {
                    daysActive++;
                    monthConversations += activity.conversations || 0;
                }
            }
            
            document.getElementById('calDaysActive').textContent = daysActive;
            document.getElementById('calConversations').textContent = monthConversations;
            
            // Calculate streak
            let streak = 0;
            const today = new Date();
            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateStr = localDateStr(checkDate);
                const activity = state.activities[dateStr];
                if (activity && (activity.types.length > 0 || activity.conversations > 0)) {
                    streak++;
                } else if (i > 0) {
                    break;
                }
            }
            document.getElementById('calStreak').textContent = streak;
            
            // Build calendar grid
            const grid = document.getElementById('calendarGrid');
            const firstDay = new Date(year, month, 1).getDay();
            const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1; // Monday start
            
            let html = '';
            
            // Day headers
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Previous month padding
            const prevMonth = month === 0 ? 11 : month - 1;
            const prevYear = month === 0 ? year - 1 : year;
            const prevMonthDays = new Date(prevYear, prevMonth + 1, 0).getDate();
            for (let i = adjustedFirstDay - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                html += `<div class="calendar-day other-month"><span class="calendar-day-number">${day}</span></div>`;
            }
            
            // Current month days
            const todayStr = localDateStr(today);
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const activity = state.activities[dateStr];
                const isToday = dateStr === todayStr;
                const hasActivity = activity && (activity.types.length > 0 || activity.conversations > 0);
                // Use configurable workdays (default 5) for daily target calculation
                const workdays = state.plan.workdays_per_week || 5;
                const dailyTarget = (state.plan.weekly_conversations || 15) / workdays;
                const targetHit = activity && activity.conversations >= dailyTarget;
                
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (hasActivity) classes += ' has-activity';
                if (targetHit) classes += ' target-hit';
                
                // Single uniform dot for any activity (simplicity over complexity)
                let indicators = hasActivity ? '<span class="calendar-dot conversation"></span>' : '';
                
                html += `
                    <div class="${classes}" onclick="viewDay('${dateStr}')">
                        <span class="calendar-day-number">${d}</span>
                        ${indicators ? `<div class="calendar-day-indicator">${indicators}</div>` : ''}
                    </div>
                `;
            }
            
            // Next month padding
            const totalCells = adjustedFirstDay + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let d = 1; d <= remainingCells; d++) {
                html += `<div class="calendar-day other-month"><span class="calendar-day-number">${d}</span></div>`;
            }
            
            grid.innerHTML = html;
        }
        
        function prevMonth() {
            if (state.calendarMonth === 0) {
                state.calendarMonth = 11;
                state.calendarYear--;
            } else {
                state.calendarMonth--;
            }
            renderCalendar();
        }
        
        function nextMonth() {
            if (state.calendarMonth === 11) {
                state.calendarMonth = 0;
                state.calendarYear++;
            } else {
                state.calendarMonth++;
            }
            renderCalendar();
        }
        
        function viewDay(dateStr) {
            openDayModal(dateStr);
        }
        
        // ==================== PROMPTS LIBRARY ====================
        function renderPrompts() {
            const container = document.getElementById('promptsContent');
            
            // Text Message Templates
            let html = `
                <div class="prompts-section" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Text Message Templates (${CONVERSATION_PROMPTS.length})</h3>
                    <div style="display: grid; gap: 0.5rem;">
                        ${CONVERSATION_PROMPTS.map(p => `
                            <div class="prompt-card" onclick="showPromptTemplate('${p.id}', 'text')">
                                <div class="prompt-header">
                                    <span class="prompt-title">${p.title}</span>
                                    <span class="prompt-toggle">→</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="prompts-section" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Social Media Templates (${SOCIAL_PROMPTS.length})</h3>
                    <div style="display: grid; gap: 0.5rem;">
                        ${SOCIAL_PROMPTS.map(p => `
                            <div class="prompt-card" onclick="showPromptTemplate('${p.id}', 'social')">
                                <div class="prompt-header">
                                    <span class="prompt-title">${p.title}</span>
                                    <span class="prompt-toggle">→</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="prompts-section" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">AI Prompts (${Object.values(AI_PROMPTS).flat().length})</h3>
                    <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.875rem;">
                        Copy these to ChatGPT or Claude. Your Brand DNA auto-fills!
                    </p>
                    
                    <h4 style="margin: 1rem 0 0.5rem; color: var(--accent);">Content Creation</h4>
                    <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                        ${AI_PROMPTS.content.map(p => `
                            <div class="prompt-card" onclick="showPromptTemplate('${p.id}', 'ai', 'content')">
                                <div class="prompt-header">
                                    <span class="prompt-title">${p.title}</span>
                                    <span class="prompt-toggle">→</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <h4 style="margin: 1rem 0 0.5rem; color: var(--accent);">Client Communication</h4>
                    <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
                        ${AI_PROMPTS.client.map(p => `
                            <div class="prompt-card" onclick="showPromptTemplate('${p.id}', 'ai', 'client')">
                                <div class="prompt-header">
                                    <span class="prompt-title">${p.title}</span>
                                    <span class="prompt-toggle">→</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <h4 style="margin: 1rem 0 0.5rem; color: var(--accent);">Planning & Strategy</h4>
                    <div style="display: grid; gap: 0.5rem;">
                        ${AI_PROMPTS.planning.map(p => `
                            <div class="prompt-card" onclick="showPromptTemplate('${p.id}', 'ai', 'planning')">
                                <div class="prompt-header">
                                    <span class="prompt-title">${p.title}</span>
                                    <span class="prompt-toggle">→</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function togglePromptsDropdown() {
            const content = document.getElementById('promptsDropdownContent');
            const toggle = document.getElementById('promptsDropdownToggle');
            content.classList.toggle('open');
            const isOpen = content.classList.contains('open');
            toggle.textContent = isOpen ? '▲' : '▼';
            
            // Remember state
            state.ui = state.ui || {};
            state.ui.promptsOpen = isOpen;
            saveState();
        }
        
        function initPromptsDropdown() {
            if (state.ui?.promptsOpen) {
                document.getElementById('promptsDropdownContent').classList.add('open');
                document.getElementById('promptsDropdownToggle').textContent = '▲';
            }
        }
        
        function togglePrompt(id) {
            document.getElementById(`prompt-${id}`).classList.toggle('open');
        }
        
        function copyPrompt(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => showNotification('Copied')).catch(() => fallbackCopy(text));
            } else {
                fallbackCopy(text);
            }
        }
        
        // ==================== REVIEW ====================
        function renderReview() {
            renderWeeklyReview();
            renderStandards();
        }
        
        function switchReviewTab(tab) {
            // Use data-tab attribute instead of fragile event.target
            document.querySelectorAll('.review-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            document.querySelectorAll('.review-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(`review-${tab}`).classList.remove('hidden');
        }
        
        function renderWeeklyReview() {
            document.getElementById('reviewWeekLabel').textContent = `Week ${state.currentWeek}`;
            document.getElementById('weeklyTargetDisplay').textContent = state.plan.weekly_conversations || 15;
            
            const weekKey = `week_${state.currentWeek}`;
            const weekData = state.weeks[weekKey] || {};
            
            document.getElementById('weekConversations').value = weekData.conversations || 0;
            document.getElementById('weekAppointments').value = weekData.appointments || 0;
            document.getElementById('weekSphere').value = weekData.sphere || 0;
            document.getElementById('dbSize').value = weekData.dbSize || 0;
            document.getElementById('dbTouched').value = weekData.dbTouched || 0;
            document.getElementById('dbReferrals').value = weekData.dbReferrals || 0;
            
            // Database health
            const dbSize = weekData.dbSize || 0;
            const dbTouched = weekData.dbTouched || 0;
            const healthPercent = dbSize > 0 ? Math.min(Math.round((dbTouched / dbSize) * 100), 100) : 0;
            const healthFill = document.getElementById('dbHealthFill');
            healthFill.style.width = `${healthPercent}%`;
            healthFill.className = 'health-meter-fill ' + (healthPercent >= 10 ? 'success' : healthPercent >= 5 ? 'warning' : 'danger');
            document.getElementById('dbHealthPercent').textContent = `${healthPercent}%`;
            
            // Reflections
            document.getElementById('weekWorked').value = weekData.worked || '';
            document.getElementById('weekDidntWork').value = weekData.didntWork || '';
            document.getElementById('weekGratitude').value = weekData.gratitude || '';
            document.getElementById('weekTruth').value = weekData.truth || '';
            document.getElementById('weekNextFocus').value = weekData.nextFocus || '';
            
            // Checklist
            const checklistContainer = document.getElementById('weeklyChecklist');
            checklistContainer.innerHTML = WEEKLY_CHECKLIST.map(item => {
                const checked = weekData.checklist && weekData.checklist[item.id];
                return `
                    <div class="check-row ${checked ? 'completed' : ''}" onclick="toggleWeeklyCheck('${item.id}')">
                        <input type="checkbox" ${checked ? 'checked' : ''}>
                        <label>${item.label}</label>
                    </div>
                `;
            }).join('');
            
            // Week counter
            document.getElementById('totalWeeksCompleted').textContent = state.weeksCompleted || 0;
            
            // Quarterly lane
            document.getElementById('quarterLane').textContent = 
                LANES.find(l => l.id === state.plan.lane)?.name || 'Not selected';
        }
        
        function saveWeekData() {
            const weekKey = `week_${state.currentWeek}`;
            if (!state.weeks[weekKey]) state.weeks[weekKey] = {};
            
            state.weeks[weekKey].conversations = parseInt(document.getElementById('weekConversations').value) || 0;
            state.weeks[weekKey].appointments = parseInt(document.getElementById('weekAppointments').value) || 0;
            state.weeks[weekKey].sphere = parseInt(document.getElementById('weekSphere').value) || 0;
            state.weeks[weekKey].dbSize = parseInt(document.getElementById('dbSize').value) || 0;
            state.weeks[weekKey].dbTouched = parseInt(document.getElementById('dbTouched').value) || 0;
            state.weeks[weekKey].dbReferrals = parseInt(document.getElementById('dbReferrals').value) || 0;
            state.weeks[weekKey].worked = document.getElementById('weekWorked').value;
            state.weeks[weekKey].didntWork = document.getElementById('weekDidntWork').value;
            state.weeks[weekKey].gratitude = document.getElementById('weekGratitude').value;
            state.weeks[weekKey].truth = document.getElementById('weekTruth').value;
            state.weeks[weekKey].nextFocus = document.getElementById('weekNextFocus').value;
            
            saveState();
            renderWeeklyReview();
        }
        
        function toggleWeeklyCheck(itemId) {
            const weekKey = `week_${state.currentWeek}`;
            if (!state.weeks[weekKey]) state.weeks[weekKey] = {};
            if (!state.weeks[weekKey].checklist) state.weeks[weekKey].checklist = {};
            
            state.weeks[weekKey].checklist[itemId] = !state.weeks[weekKey].checklist[itemId];
            saveState();
            renderWeeklyReview();
        }
        
        function prevWeek() {
            if (state.currentWeek > 1) {
                state.currentWeek--;
                renderWeeklyReview();
            }
        }
        
        function nextWeek() {
            if (state.currentWeek < 52) {
                state.currentWeek++;
                renderWeeklyReview();
            }
        }
        
        function markWeekComplete() {
            const weekKey = `week_${state.currentWeek}`;
            if (!state.weeks[weekKey]) state.weeks[weekKey] = {};
            
            if (!state.weeks[weekKey].completed) {
                state.weeks[weekKey].completed = true;
                state.weeksCompleted = (state.weeksCompleted || 0) + 1;
                saveState();
                
                // Quiet confirmation — no confetti for system interactions
                showNotification(`Week ${state.currentWeek} recorded.`);
                
                renderWeeklyReview();
                updateCommandCenter();
                checkStreak();
            } else {
                showNotification('Week already recorded.');
            }
        }
        
        function saveMonthData() {
            // Save monthly pulse data
            const monthKey = `month_${state.calendarMonth}_${state.calendarYear}`;
            if (!state.months[monthKey]) state.months[monthKey] = {};
            
            state.months[monthKey].energy = document.getElementById('monthEnergy').value;
            state.months[monthKey].balance = document.getElementById('monthBalance').value;
            state.months[monthKey].confidence = document.getElementById('monthConfidence').value;
            state.months[monthKey].weighing = document.getElementById('monthWeighing').value;
            state.months[monthKey].well = document.getElementById('monthWell').value;
            
            saveState();
        }
        
        function saveQuarterData() {
            // Save quarterly review data
            const quarter = Math.ceil((state.calendarMonth + 1) / 3);
            const quarterKey = `q${quarter}_${state.calendarYear}`;
            if (!state.quarters[quarterKey]) state.quarters[quarterKey] = {};
            
            state.quarters[quarterKey].execution = document.getElementById('quarterExecution').value;
            state.quarters[quarterKey].results = document.getElementById('quarterResults').value;
            
            saveState();
        }
        
        function setQuarterDecision(decision) {
            const quarter = Math.ceil((state.calendarMonth + 1) / 3);
            const quarterKey = `q${quarter}_${state.calendarYear}`;
            if (!state.quarters[quarterKey]) state.quarters[quarterKey] = {};
            
            state.quarters[quarterKey].decision = decision;
            saveState();
            
            if (decision === 'continue') {
                showNotification('Lane confirmed.');
            } else {
                showNotification('Lane change initiated.');
                openLaneSelector();
            }
        }
        
        function renderStandards() {
            const container = document.getElementById('standardsContainer');
            container.innerHTML = STANDARDS.map(std => {
                const checked = state.standards[std.id];
                return `
                    <div class="standard-card" id="standard-${std.id}">
                        <div class="standard-header" onclick="toggleStandard(${std.id})">
                            <span class="standard-number">${std.id}</span>
                            <span class="standard-title">${std.title}</span>
                            ${checked ? '<span class="standard-check">✓</span>' : ''}
                        </div>
                        <div class="standard-content">
                            <p style="margin-bottom: 1rem;">${std.description}</p>
                            <button class="btn btn-sm ${checked ? 'btn-secondary' : 'btn-primary'}" 
                                    onclick="markStandard(${std.id}, ${!checked}); event.stopPropagation();">
                                ${checked ? 'Unmark' : 'I meet this standard'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleStandard(id) {
            document.getElementById(`standard-${id}`).classList.toggle('open');
        }
        
        function markStandard(id, value) {
            state.standards[id] = value;
            saveState();
            renderStandards();
        }
        
        // ==================== BUILD STEPS ====================
        function renderBuildSteps() {
            const container = document.getElementById('buildStepsContainer');
            
            // Find first incomplete step for "resume" feature
            const firstIncompleteStep = BUILD_STEPS.find(step => !state.buildProgress[step.id]);
            
            container.innerHTML = BUILD_STEPS.map(step => {
                const completed = state.buildProgress[step.id];
                const isNextStep = firstIncompleteStep && step.id === firstIncompleteStep.id;
                return `
                    <div class="build-step ${completed ? 'completed' : ''} ${isNextStep ? 'open' : ''}" id="build-step-${step.id}">
                        <div class="build-step-header" onclick="toggleBuildStep(${step.id})">
                            <span class="build-step-number">${completed ? '✓' : step.id}</span>
                            <span class="build-step-title">${escapeHtml(step.title)}${isNextStep && !completed ? ' ← Resume here' : ''}</span>
                            <span class="build-step-toggle">▼</span>
                        </div>
                        <div class="build-step-content">
                            ${renderBuildStepContent(step)}
                        </div>
                    </div>
                `;
            }).join('');
            
            updateBuildProgress();
        }
        
        function renderBuildStepContent(step) {
            // Simplified for now - would have full form fields for each step
            switch(step.id) {
                case 1:
                    return `
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Why are you here? What drove you to seek a system?</p>
                        <div class="form-group">
                            <textarea id="build_reflection_why" placeholder="Be honest with yourself..." 
                                      onchange="saveBuildStep(1, 'reflection_why', this.value)">${state.plan.reflection_why || ''}</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(1)">Continue</button>
                    `;
                case 2:
                    return `
                        <div class="form-group">
                            <label>Your Name</label>
                            <input type="text" id="build_name" placeholder="First and Last" 
                                   value="${state.plan.name || ''}"
                                   onchange="saveBuildStep(2, 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Your Market Area</label>
                            <input type="text" id="build_market" placeholder="e.g., Northern Colorado" 
                                   value="${state.plan.market || ''}"
                                   onchange="saveBuildStep(2, 'market', this.value)">
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(2)">Continue</button>
                    `;
                case 3:
                    return `
                        <div class="form-group">
                            <label>Who do you serve best?</label>
                            <textarea id="build_who" placeholder="First-time buyers, empty nesters, investors..." 
                                      onchange="saveBuildStep(3, 'who_i_serve', this.value)">${state.plan.who_i_serve || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Who is NOT a fit for you?</label>
                            <textarea id="build_notfor" placeholder="Be specific about who you don't work best with..." 
                                      onchange="saveBuildStep(3, 'not_for', this.value)">${state.plan.not_for || ''}</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(3)">Continue</button>
                    `;
                case 9:
                    return `
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Choose ONE lane and commit for 90 days.</p>
                        <div id="buildLaneOptions">
                            ${LANES.map(lane => `
                                <div class="lane-option ${state.plan.lane === lane.id ? 'selected' : ''}" 
                                     data-lane-id="${lane.id}"
                                     onclick="selectBuildLane('${lane.id}')">
                                    <span class="lane-option-icon">${lane.icon}</span>
                                    <div class="lane-option-info">
                                        <h4>${lane.name}</h4>
                                        <p>${lane.description}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(9)" style="margin-top: 1rem;">Commit to This Lane</button>
                    `;
                case 4:
                    return `
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">How do you want people to feel when they interact with you? This becomes your content voice.</p>
                        <div class="form-group">
                            <label>My voice feels like...</label>
                            <textarea id="build_voice" placeholder="e.g., Warm, knowledgeable neighbor. Direct but never pushy. Calm in chaos. The friend who happens to know real estate." 
                                      onchange="saveBuildStep(4, 'voice_feels_like', this.value)">${state.plan.voice_feels_like || ''}</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(4)">Continue</button>
                    `;
                case 5:
                    return `
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">What makes you different from every other agent? What's your superpower?</p>
                        <div class="form-group">
                            <label>What makes you different?</label>
                            <textarea id="build_diff" placeholder="e.g., I specialize in CHFA grants and help buyers who've been told they can't afford a home. I know the shortcuts, the programs, and the people who can help." 
                                      onchange="saveBuildStep(5, 'differentiator', this.value)">${state.plan.differentiator || ''}</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(5)">Continue</button>
                    `;
                case 6:
                    return `
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">This is your elevator pitch. Why should someone work with YOU over anyone else?</p>
                        <div class="form-group">
                            <label>Why should someone work with you?</label>
                            <textarea id="build_why" placeholder="e.g., Because I've helped 400+ families navigate what feels impossible. I fight for my clients and I don't stop until they have keys in hand." 
                                      onchange="saveBuildStep(6, 'why_you', this.value)">${state.plan.why_you || ''}</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(6)">Continue</button>
                    `;
                case 7:
                    return `
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">People connect with stories, not credentials. What's the story that made you who you are?</p>
                        <div class="form-group">
                            <label>Your origin story</label>
                            <textarea id="build_origin" placeholder="e.g., I got into real estate after my own home-buying disaster. I promised myself I'd never let another family go through what I did..." 
                                      onchange="saveBuildStep(7, 'origin_story', this.value)">${state.plan.origin_story || ''}</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(7)">Continue</button>
                    `;
                case 8:
                    return `
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Your message framework is the foundation of all your marketing. Complete this statement:</p>
                        <div class="ceo-line" style="margin-bottom: 1rem;">I help [WHO] do [WHAT] so they can [RESULT]. Unlike [ALTERNATIVE], I [DIFFERENTIATOR].</div>
                        <div class="form-group">
                            <label>Your message framework</label>
                            <textarea id="build_message" placeholder="I help first-time buyers navigate the overwhelming home-buying process so they can own a home without the stress. Unlike agents who just open doors, I guide every step and fight for the best deal." 
                                      onchange="saveBuildStep(8, 'message_framework', this.value)">${state.plan.message_framework || ''}</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(8)">Continue</button>
                    `;
                case 10:
                    return `
                        <div class="form-group">
                            <label>Income Goal (Annual GCI)</label>
                            <input type="text" id="build_income" placeholder="$100,000" 
                                   value="${state.profile.incomeGoal ? formatCurrency(state.profile.incomeGoal) : ''}"
                                   onchange="saveBuildStep(10, 'income_goal', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Average GCI per Transaction</label>
                            <input type="text" id="build_avggci" placeholder="$8,000" 
                                   value="${state.profile.avgGci ? formatCurrency(state.profile.avgGci) : ''}"
                                   onchange="saveBuildStep(10, 'avg_gci', this.value)">
                        </div>
                        <div class="ceo-line" style="margin: 1rem 0;">
                            Based on your numbers, your Calm Number is: <strong>${calculateCalmNumber()}</strong> conversations per day
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(10)">Continue</button>
                    `;
                case 11:
                    return `
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">When is your protected CEO Hour? This is sacred time for lead generation.</p>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Day</label>
                                <select id="build_ceoday" onchange="saveBuildStep(11, 'ceo_day', this.value)">
                                    <option value="">Select day...</option>
                                    <option value="Monday" ${state.plan.ceo_day === 'Monday' ? 'selected' : ''}>Monday</option>
                                    <option value="Tuesday" ${state.plan.ceo_day === 'Tuesday' ? 'selected' : ''}>Tuesday</option>
                                    <option value="Wednesday" ${state.plan.ceo_day === 'Wednesday' ? 'selected' : ''}>Wednesday</option>
                                    <option value="Thursday" ${state.plan.ceo_day === 'Thursday' ? 'selected' : ''}>Thursday</option>
                                    <option value="Friday" ${state.plan.ceo_day === 'Friday' ? 'selected' : ''}>Friday</option>
                                    <option value="Daily" ${state.plan.ceo_day === 'Daily' ? 'selected' : ''}>Daily</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Time</label>
                                <input type="time" id="build_ceotime" 
                                       value="${state.plan.ceo_time || ''}"
                                       onchange="saveBuildStep(11, 'ceo_time', this.value)">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(11)">Continue</button>
                    `;
                case 12:
                    return `
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">What's the ONE thing you'll focus on for the next 30 days? Pick one and go all-in.</p>
                        <div class="form-group">
                            <label>My 30-Day Focus</label>
                            <select id="build_focus" onchange="saveBuildStep(12, 'business_focus', this.value)">
                                <option value="">Select your focus...</option>
                                <option value="Lead Generation" ${state.plan.business_focus === 'Lead Generation' ? 'selected' : ''}>Lead Generation - Fill my pipeline</option>
                                <option value="Conversion" ${state.plan.business_focus === 'Conversion' ? 'selected' : ''}>Conversion - Turn leads into appointments</option>
                                <option value="Closing" ${state.plan.business_focus === 'Closing' ? 'selected' : ''}>Closing - Get deals across the finish line</option>
                                <option value="Sphere Building" ${state.plan.business_focus === 'Sphere Building' ? 'selected' : ''}>Sphere Building - Strengthen relationships</option>
                                <option value="Systems" ${state.plan.business_focus === 'Systems' ? 'selected' : ''}>Systems - Build repeatable processes</option>
                                <option value="Content" ${state.plan.business_focus === 'Content' ? 'selected' : ''}>Content - Increase visibility</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Why this focus? What will it unlock?</label>
                            <textarea id="build_focus_why" placeholder="I'm focusing on this because..." 
                                      onchange="saveBuildStep(12, 'focus_why', this.value)">${state.plan.focus_why || ''}</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(12)">Continue</button>
                    `;
                case 13:
                    return `
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">What are your non-negotiables? The things you do NO MATTER WHAT?</p>
                        <div class="form-group">
                            <label>My Non-Negotiables (check all that apply)</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" onchange="updateNonNegotiables()" class="nn-check" value="CEO Hour daily" ${(state.plan.non_negotiables || '').includes('CEO Hour') ? 'checked' : ''}>
                                    <span>CEO Hour daily (lead gen time)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" onchange="updateNonNegotiables()" class="nn-check" value="Weekly conversations target" ${(state.plan.non_negotiables || '').includes('Weekly conversations') ? 'checked' : ''}>
                                    <span>Hit my weekly conversations target</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" onchange="updateNonNegotiables()" class="nn-check" value="Same-day lead follow-up" ${(state.plan.non_negotiables || '').includes('Same-day') ? 'checked' : ''}>
                                    <span>Same-day lead follow-up</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" onchange="updateNonNegotiables()" class="nn-check" value="Weekly sphere touches" ${(state.plan.non_negotiables || '').includes('sphere touches') ? 'checked' : ''}>
                                    <span>Weekly sphere touches</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" onchange="updateNonNegotiables()" class="nn-check" value="Weekly review" ${(state.plan.non_negotiables || '').includes('Weekly review') ? 'checked' : ''}>
                                    <span>Weekly review of numbers</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Add your own:</label>
                            <input type="text" id="build_nn_custom" placeholder="My personal non-negotiable..." 
                                   onchange="saveBuildStep(13, 'nn_custom', this.value)" value="${state.plan.nn_custom || ''}">
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(13)">Continue</button>
                    `;
                case 14:
                    return `
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">This is it. Your commitment to yourself. Write it like you mean it.</p>
                        <div class="ceo-line" style="margin-bottom: 1rem;">
                            "I commit to staying in my lane for 90 days. I commit to ${state.plan.weekly_conversations || 15} conversations per week. I commit to my CEO Hour. I commit to tracking my progress. I will not quit on myself."
                        </div>
                        <div class="form-group">
                            <label>Your Personal Commitment</label>
                            <textarea id="build_commit" placeholder="I commit to..." 
                                      onchange="saveBuildStep(14, 'commitment', this.value)">${state.plan.commitment || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="build_commit_check" ${state.plan.commitment_confirmed ? 'checked' : ''} 
                                       onchange="saveBuildStep(14, 'commitment_confirmed', this.checked)">
                                <span>I understand this system only works if I do. I'm ready.</span>
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(14)">Complete Setup</button>
                    `;
                default:
                    return `
                        <div class="form-group">
                            <textarea placeholder="Enter your response..." 
                                      onchange="saveBuildStep(${step.id}, '${step.fields[0]}', this.value)">${state.plan[step.fields[0]] || ''}</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="completeBuildStep(${step.id})">Continue</button>
                    `;
            }
        }
        
        function toggleBuildStep(id) {
            const step = document.getElementById(`build-step-${id}`);
            // Close all others
            document.querySelectorAll('.build-step').forEach(s => {
                if (s.id !== `build-step-${id}`) s.classList.remove('open');
            });
            step.classList.toggle('open');
        }
        
        function saveBuildStep(stepId, field, value) {
            if (field === 'income_goal') {
                state.profile.incomeGoal = parseGci(value);
            } else if (field === 'avg_gci') {
                state.profile.avgGci = parseGci(value);
            } else {
                state.plan[field] = value;
            }
            saveState();
        }
        
        function selectBuildLane(laneId) {
            state.plan.lane = laneId;
            saveState();
            
            // Update UI using data attribute (not brittle text matching)
            document.querySelectorAll('#buildLaneOptions .lane-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.laneId === laneId);
            });
        }
        
        function updateNonNegotiables() {
            const checked = Array.from(document.querySelectorAll('.nn-check:checked')).map(cb => cb.value);
            state.plan.non_negotiables = checked.join(', ');
            saveState();
        }
        
        function completeBuildStep(stepId) {
            state.buildProgress[stepId] = true;
            saveState();
            
            // Close current and open next
            document.getElementById(`build-step-${stepId}`).classList.remove('open');
            if (stepId < 14) {
                document.getElementById(`build-step-${stepId + 1}`).classList.add('open');
            }
            
            renderBuildSteps();
            updateCommandCenter();
            
            if (stepId === 14) {
                // Quiet confirmation — confetti reserved for real outcomes
                showNotification('Setup complete. Begin.');
            }
        }
        
        function updateBuildProgress() {
            const completed = Object.values(state.buildProgress).filter(Boolean).length;
            const total = BUILD_STEPS.length;
            const percent = Math.round((completed / total) * 100);
            
            document.getElementById('buildProgressFill').style.width = `${percent}%`;
            document.getElementById('buildProgressText').textContent = `${percent}%`;
        }
        
        // ==================== HELP ====================
        function renderHelp() {
            const container = document.getElementById('helpContainer');
            container.innerHTML = HELP_FAQ.map((item, idx) => `
                <div class="help-item" id="help-${idx}">
                    <div class="help-question" onclick="toggleHelp(${idx})">
                        ${item.q}
                        <span>▼</span>
                    </div>
                    <div class="help-answer">${item.a}</div>
                </div>
            `).join('');
        }
        
        function toggleHelp(idx) {
            document.getElementById(`help-${idx}`).classList.toggle('open');
        }
        
        // ==================== UTILITIES ====================
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        }
        
        let notificationTimer = null;
        
        function showNotification(message) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.classList.add('show');
            
            // Clear previous timer to prevent overlap
            if (notificationTimer) clearTimeout(notificationTimer);
            notificationTimer = setTimeout(() => notif.classList.remove('show'), 3000);
        }
        
        let confettiCooldown = false;
        
        function triggerConfetti() {
            // Prevent confetti spam if triggered multiple times quickly
            if (confettiCooldown) return;
            confettiCooldown = true;
            setTimeout(() => confettiCooldown = false, 1500);
            
            const container = document.getElementById('confettiContainer');
            container.textContent = ''; // Clear any existing confetti
            
            const colors = ['#00d4aa', '#f7931e', '#3b82f6', '#ef4444', '#8b5cf6', '#f59e0b'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animation = `confetti-fall ${1.5 + Math.random()}s ease forwards`;
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }
        
        function exportData() {
            // Update backup timestamp
            state.lastBackup = new Date().toISOString();
            saveState();
            
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `closing-lane-backup-${localDateStr()}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            dismissBackupReminder();
            showNotification('Backup downloaded');
        }
        
        function triggerImport() {
            document.getElementById('importFile').click();
        }
        
        function validateImportData(data) {
            // Check it's an object
            if (!data || typeof data !== 'object') {
                return { valid: false, error: 'Invalid file format' };
            }
            
            // Check for obviously wrong data
            if (Array.isArray(data)) {
                return { valid: false, error: 'Invalid data structure' };
            }
            
            // Validate deals array if present
            if (data.deals && !Array.isArray(data.deals)) {
                return { valid: false, error: 'Deals data is corrupted' };
            }
            
            // Validate activities object if present
            if (data.activities && typeof data.activities !== 'object') {
                return { valid: false, error: 'Activities data is corrupted' };
            }
            
            return { valid: true };
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file type
            if (!file.name.endsWith('.json')) {
                showNotification('Please select a JSON file');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Validate imported data
                    const validation = validateImportData(imported);
                    if (!validation.valid) {
                        showNotification(validation.error);
                        return;
                    }
                    
                    if (!confirm('This will replace all your current data. Are you sure?')) {
                        return;
                    }
                    
                    // Use migrateState to ensure all fields exist
                    state = migrateState({ ...state, ...imported });
                    
                    saveState();
                    initApp();
                    showNotification('Data restored successfully');
                } catch(err) {
                    showNotification('Error importing file. Check the format.');
                    console.error('Import error:', err);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        function confirmReset() {
            if (!confirm('Are you sure? This will delete ALL your data and cannot be undone.')) return;
            if (!confirm('Really really sure? Last chance to back out.')) return;
            
            localStorage.removeItem('closingLaneState_v2');
            location.reload();
        }
        
        function showDoctrine() {
            document.getElementById('doctrineModal').classList.remove('hidden');
        }
        
        function acceptDoctrine() {
            state.doctrineAccepted = true;
            state.doctrineAcceptedDate = new Date().toISOString();
            saveState();
            document.getElementById('doctrineModal').classList.add('hidden');
            
            // Show quick setup if not completed
            if (!state.quickSetupComplete) {
                showQuickSetup();
            }
        }
        
        function showQuickSetup() {
            // Render lane options
            const container = document.getElementById('setupLaneOptions');
            container.innerHTML = LANES.map(lane => `
                <div class="setup-lane-option" data-lane="${lane.id}" onclick="selectSetupLane('${lane.id}')" 
                     style="padding: 0.6rem 0.75rem; border: 2px solid var(--card-border); border-radius: 8px; cursor: pointer; transition: all 0.15s;">
                    <span style="font-size: 1.1rem; margin-right: 0.5rem;">${lane.icon}</span>
                    <span style="font-size: 0.85rem;">${lane.name}</span>
                </div>
            `).join('');
            
            document.getElementById('quickSetupModal').classList.remove('hidden');
        }
        
        let selectedSetupLane = null;
        
        function selectSetupLane(laneId) {
            selectedSetupLane = laneId;
            document.querySelectorAll('.setup-lane-option').forEach(el => {
                if (el.dataset.lane === laneId) {
                    el.style.borderColor = 'var(--accent)';
                    el.style.background = 'var(--accent-alpha)';
                } else {
                    el.style.borderColor = 'var(--card-border)';
                    el.style.background = 'transparent';
                }
            });
        }
        
        function completeQuickSetup() {
            const name = document.getElementById('setup_name').value.trim();
            const income = parseInt(document.getElementById('setup_income').value) || 0;
            const gci = parseInt(document.getElementById('setup_gci').value) || 8000;
            
            if (!name) {
                showNotification('Please enter your name');
                return;
            }
            if (!selectedSetupLane) {
                showNotification('Please select a lane');
                return;
            }
            if (!income) {
                showNotification('Please enter your income goal');
                return;
            }
            
            // Save to state
            state.plan.name = name;
            state.plan.lane = selectedSetupLane;
            state.laneSelectedDate = new Date().toISOString();
            state.profile.incomeGoal = income;
            state.profile.avgGci = gci;
            state.quickSetupComplete = true;
            
            // Mark first 2 build steps as complete (they entered name)
            state.buildProgress[1] = true;
            state.buildProgress[2] = true;
            state.buildProgress[9] = true; // Lane
            state.buildProgress[10] = true; // Math
            
            saveState();
            
            // Close modal and refresh dashboard
            document.getElementById('quickSetupModal').classList.add('hidden');
            updateCommandCenter();
            renderPipeline();
            renderBuildSteps();
            
            const laneName = LANES.find(l => l.id === selectedSetupLane)?.name || 'your lane';
            showNotification(`Welcome, ${name}! You're in ${laneName}.`);
        }
        
        function checkFirstTimeUser() {
            if (!state.doctrineAccepted) {
                showDoctrine();
            } else if (!state.quickSetupComplete) {
                showQuickSetup();
            }
        }
    </script>
    
    <!-- Footer -->
    <footer style="text-align: center; padding: 2rem 1rem; margin-top: 3rem; border-top: 1px solid var(--card-border);">
        <p style="font-size: 0.75rem; color: var(--text-muted);">THE CLOSING LANE™ — 2026 Edition v2.1</p>
        <p style="font-size: 0.65rem; color: var(--text-muted); margin-top: 0.75rem;">
            Predictable income is built by repeatable weeks.<br>
            © 2025 THE CLOSING LANE™. All rights reserved. Single-user license.
        </p>
    </footer>
</body>
</html>
